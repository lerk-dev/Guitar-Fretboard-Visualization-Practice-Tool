<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ä»–éŸ³é˜¶ä¸å’Œå¼¦ç»ƒä¹ å·¥å…·</title>
    <script>
    // PitchFinderåº“å†…è”ä»£ç  - ç›´æ¥åµŒå…¥YINç®—æ³•å®ç°
    (function(global) {
        // PitchFinderä¸»å¯¹è±¡
        var Pitchfinder = {};
        
        // YINç®—æ³•å®ç°
        Pitchfinder.YIN = function(config) {
            var DEFAULT_THRESHOLD = 0.1;
            
            config = config || {};
            var threshold = config.threshold || DEFAULT_THRESHOLD;
            
            return function(float32AudioBuffer) {
                // å®ç°YINç®—æ³•
                var bufferLength = float32AudioBuffer.length;
                var halfLength = Math.floor(bufferLength / 2);
                var yinBuffer = new Float32Array(halfLength);
                
                // æ­¥éª¤1: è‡ªç›¸å…³å‡½æ•°
                for (var t = 0; t < halfLength; t++) {
                    yinBuffer[t] = 0;
                    for (var i = 0; i < halfLength; i++) {
                        var delta = float32AudioBuffer[i] - float32AudioBuffer[i + t];
                        yinBuffer[t] += delta * delta;
                    }
                }
                
                // æ­¥éª¤2: ç´¯ç§¯å½’ä¸€åŒ–å¹³å‡å·®å‡½æ•°
                var runningSum = 0;
                yinBuffer[0] = 1;
                for (var t = 1; t < halfLength; t++) {
                    runningSum += yinBuffer[t];
                    yinBuffer[t] *= t / runningSum;
                }
                
                // æ­¥éª¤3: é˜ˆå€¼å‡½æ•°
                var tau = 0;
                for (var t = 1; t < halfLength; t++) {
                    if (yinBuffer[t] < threshold) {
                        while (t + 1 < halfLength && yinBuffer[t + 1] < yinBuffer[t]) {
                            t++;
                        }
                        tau = t;
                        break;
                    }
                }
                
                // æ­¥éª¤4: ç²¾ç¡®å‘¨æœŸä¼°è®¡
                var period;
                if (tau === 0) {
                    period = 0;
                } else {
                    // ä½¿ç”¨æŠ›ç‰©çº¿æ’å€¼æé«˜ç²¾åº¦
                    var betterTau = tau;
                    if (tau < halfLength - 1) {
                        var s0 = yinBuffer[tau - 1];
                        var s1 = yinBuffer[tau];
                        var s2 = yinBuffer[tau + 1];
                        var adjustment = (s2 - s0) / (2 * (2 * s1 - s2 - s0));
                        betterTau = tau + adjustment;
                    }
                    period = betterTau;
                }
                
                // è®¡ç®—é¢‘ç‡ - å¦‚æœå‘¨æœŸä¸º0ï¼Œåˆ™è¿”å›-1è¡¨ç¤ºæ— æ³•æ£€æµ‹
                var frequency = period !== 0 ? 48000 / period : -1;
                
                // è¿‡æ»¤æ‰ä¸åˆç†çš„é¢‘ç‡å€¼
                if (frequency < 65 || frequency > 4000) {
                    return null;
                }
                
                return frequency;
            };
        };
        
        // å°†PitchFinderæš´éœ²ç»™å…¨å±€
        global.Pitchfinder = Pitchfinder;
    })(window);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a3a, #0d1b2a);
            color: #e0e0e0;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background-color: rgba(40, 40, 50, 0.9);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 152, 0, 0.3);
            padding-bottom: 15px;
        }
        
        h1 {
            color: #ff9800;
            margin-bottom: 10px;
            font-size: 28px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .instructions {
            color: #b0b0b0;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        /* æ‰‹æœºAPPå¼è®¾ç½®é¢æ¿ - ç´§å‡‘ç‰ˆ */
        .settings-panel {
            background: linear-gradient(to right, rgba(51, 51, 51, 0.8), rgba(60, 60, 70, 0.8));
            border-radius: 12px;
            padding: 0;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        /* é€‰é¡¹å¡å¼å¯¼èˆª */
        .settings-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(40, 40, 50, 0.8);
        }
        
        .settings-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        
        .settings-tab.active {
            color: #ff9800;
            border-bottom: 2px solid #ff9800;
            background: rgba(255, 152, 0, 0.1);
        }
        
        /* è®¾ç½®å†…å®¹åŒºåŸŸ */
        .settings-content {
            padding: 12px;
        }
        
        .settings-section {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #ff9800;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }
        
        .settings-section-title i {
            margin-right: 10px;
            font-size: 20px;
        }
        
        .settings-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .settings-label {
            font-size: 14px;
            color: #e0e0e0;
            margin-bottom: 6px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .settings-label .info {
            color: #888;
            font-size: 14px;
        }
        
        /* æ‰‹æœºå‹å¥½çš„é€‰æ‹©æ¡† */
        .select-wrapper {
            position: relative;
            width: 100%;
        }
        
        .select-wrapper::after {
            content: "â–¼";
            font-size: 10px;
            color: #ff9800;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        
        select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #2c2c3c;
            color: #fff;
            font-size: 14px;
            appearance: none;
            -webkit-appearance: none;
            outline: none;
            transition: all 0.2s;
        }
        
        select:focus {
            border-color: #ff9800;
            box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.3);
        }
        
        /* å¼€å…³æ ·å¼ */
        .switch-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
        }
        
        .switch-label {
            font-size: 14px;
            color: #e0e0e0;
            font-weight: 500;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 30px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #ff9800;
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        /* å’Œå¼¦ç±»å‹é€‰æ‹©å™¨ - æ”¹ä¸ºæŒ‰é’®å¼ */
        .chord-type-container {
            display: grid;
            grid-template-columns: repeat(4, minmax(min-content, 1fr));
            gap: 8px;
            width: 100%;
        }
        
        .chord-type-btn {
            padding: 8px 6px;
            border-radius: 6px;
            border: 1px solid #555;
            background-color: #2c2c3c;
            color: #aaa;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 0;
            white-space: nowrap;
        }
        
        .chord-type-btn.active {
            background-color: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            border-color: #ff9800;
        }
        
        /* é¡ºåº/ä¹±åºæŒ‰é’®æ ·å¼ */
        .order-btn-container {
            display: flex;
            gap: 8px;
            width: 100%;
        }
        
        .order-btn {
            flex: 1;
            padding: 10px 8px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #2c2c3c;
            color: #aaa;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .order-btn.active {
            background-color: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            border-color: #ff9800;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 18px 32px;
            border: none;
            border-radius: 16px;
            background: linear-gradient(to right, #4fc3f7, #29b6f6);
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            flex: 1;
            max-width: 280px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (min-width: 768px) {
            .chord-type-container {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .settings-row {
                flex-direction: row;
                align-items: center;
            }
            
            .settings-label {
                min-width: 100px;
                margin-bottom: 0;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .btn {
                padding: 16px 24px;
                font-size: 16px;
            }
            
            .settings-section-title {
                font-size: 16px;
            }
            
            .settings-tab {
                padding: 14px 12px;
                font-size: 14px;
            }
        }

        /* èŠ‚æ‹å™¨é—ªçƒåŠ¨ç”» */
        @keyframes metronome-flash {
            0% { background: linear-gradient(135deg, #0f172a, #1e293b); }
            10% { background: linear-gradient(135deg, #1a2942, #2a3c52); }
            20% { background: linear-gradient(135deg, #0f172a, #1e293b); }
        }
        
        /* èŠ‚æ‹å™¨æ¿€æ´»æ—¶çš„èƒŒæ™¯é—ªçƒ */
        .metronome-active {
            animation: metronome-flash var(--metronome-speed) infinite;
        }

        /* ç»ƒä¹ æ¨¡å¼å…¨å±æ ·å¼ï¼ˆä¿æŒä¸å˜ï¼‰ */
        #practiceScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            backdrop-filter: blur(10px);
        }
        
        .exercise-container {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.95), rgba(71, 85, 105, 0.95));
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            text-align: center;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            max-width: 800px;
            backdrop-filter: blur(10px);
        }
        
        .scale-info {
            margin-bottom: 24px;
        }
        
        .target-interval {
            font-size: 36px;
            font-weight: 700;
            color: #38bdf8;
            margin: 12px 0;
            text-shadow: 0 4px 8px rgba(56, 189, 248, 0.3);
            letter-spacing: -0.5px;
        }
        
        .sequence-display {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .sequence-title {
            font-size: 16px;
            color: #94a3b8;
            margin-bottom: 16px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .sequence-items {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 6px;
            padding: 10px 0;
            margin: 0 auto;
            width: 100%;
        }
        
        .sequence-item {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 700;
            color: #ff8a00;
            transition: all 0.3s ease;
            padding: 8px;
            border-radius: 6px;
            background: rgba(51, 65, 85, 0.9);
            min-width: 36px;
            height: 36px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            flex: 0 1 auto;
        }
        
        .sequence-item.played {
            color: #64748b !important;
            background: rgba(30, 41, 59, 0.6) !important;
            box-shadow: none !important;
            border-color: rgba(100, 116, 139, 0.3);
            transform: scale(0.95);
        }
        
        .sequence-item.current {
            color: #38bdf8;
            background: rgba(56, 189, 248, 0.15);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            border-color: rgba(56, 189, 248, 0.3);
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(56, 189, 248, 0.6);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            }
        }
        
        .next-exercise {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-top: 24px;
            width: 100%;
            max-width: 700px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        .next-label {
            font-size: 14px;
            color: #94a3b8;
            white-space: nowrap;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .next-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        
        .next-content {
            font-size: 16px;
            color: #ff8a00;
            font-weight: 600;
            text-align: center;
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1001;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-recording {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .status-ready {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        /* é”®ç›˜å¿«æ·é”®æç¤º */
        .shortcut-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .shortcut-key {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            margin: 0 4px;
            font-weight: 600;
            color: #ff8a00;
        }
        
        /* å®æ—¶éŸ³é«˜æ˜¾ç¤º */
        .pitch-display {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.8);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .pitch-display.in-tune {
            border-color: rgba(34, 197, 94, 0.5);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }
        
        .pitch-display.out-of-tune {
            border-color: rgba(239, 68, 68, 0.5);
        }
        
        .confidence-bar {
            margin-top: 8px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: #38bdf8;
            border-radius: 2px;
            transition: width 0.2s ease;
        }
    </style>
</head>
<body>
    <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="status-indicator status-ready" id="statusIndicator">å‡†å¤‡å°±ç»ª</div>
    
    <!-- é”®ç›˜å¿«æ·é”®æç¤º -->
    <div class="shortcut-hint" id="shortcutHint">
        æŒ‰ <span class="shortcut-key">ESC</span> è¿”å›ä¸»èœå•
    </div>
    
    <!-- å®æ—¶éŸ³é«˜æ˜¾ç¤º -->
    <div class="pitch-display" id="pitchDisplay" style="display: none;">
        <div>éŸ³é«˜: --</div>
        <div>éŸ³åˆ†å·®: 0</div>
        <div class="confidence-bar">
            <div class="confidence-fill" style="width: 0%"></div>
        </div>
    </div>
    
    <div class="container" id="mainScreen">
        <div class="header">
            <h1>ğŸ¸ å‰ä»–éŸ³é˜¶ä¸å’Œå¼¦ç»ƒä¹ å·¥å…·</h1>
            <div class="instructions">
                ä½¿ç”¨éº¦å…‹é£æ‹¾éŸ³ï¼Œåœ¨æ­£ç¡®éŸ³é«˜ä¸Šä¸‹20éŸ³åˆ†èŒƒå›´å†…å³åˆ¤å®šå¼¹å¯¹ã€‚ç‚¹å‡»å¼€å§‹ç»ƒä¹ è¿›å…¥å…¨å±æ¨¡å¼ã€‚
            </div>
        </div>
        
        <!-- æ‰‹æœºAPPå¼è®¾ç½®é¢æ¿ -->
        <div class="settings-panel">
            <!-- é€‰é¡¹å¡å¯¼èˆª -->
            <div class="settings-tabs">
                <div class="settings-tab active" data-tab="scale">éŸ³é˜¶ç»ƒä¹ </div>
                <div class="settings-tab" data-tab="chord">å’Œå¼¦ç»ƒä¹ </div>
            </div>
            
            <!-- è®¾ç½®å†…å®¹åŒºåŸŸ -->
            <div class="settings-content">
                <!-- èŠ‚æ‹å™¨è®¾ç½® -->
                <div class="settings-section">
                    <div class="settings-section-title">
                        <i>ğŸ¯</i> èŠ‚æ‹å™¨è®¾ç½®
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="switch-label">å¯ç”¨èŠ‚æ‹å™¨</span>
                            <label class="switch">
                                <input type="checkbox" id="metronomeToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; width: 60%; margin-left: auto;">
                            <span style="white-space: nowrap; font-size: 14px;">é€Ÿåº¦:</span>
                            <input type="range" id="metronomeTempo" min="20" max="120" step="1" value="40" style="width: 65%; margin-right: 3px;">
                            <span id="metronomeTempoValue" style="min-width: 25px; text-align: right; font-size: 14px;">40</span>
                        </div>
                    </div>
                </div>
                
                <!-- éŸ³é˜¶è®¾ç½® -->
                <div class="settings-section scale-settings">
                    <div class="settings-section-title">
                        <i>ğŸµ</i> éŸ³é˜¶è®¾ç½®
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-label">
                            æ ¹éŸ³
                            <span class="info">é€‰æ‹©éŸ³é˜¶çš„èµ·å§‹éŸ³ç¬¦</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="rootNote">
                                <option value="C">C</option>
                                <option value="Câ™¯">Câ™¯</option>
                                <option value="D">D</option>
                                <option value="Dâ™¯">Dâ™¯</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="Fâ™¯">Fâ™¯</option>
                                <option value="G">G</option>
                                <option value="Gâ™¯">Gâ™¯</option>
                                <option value="A">A</option>
                                <option value="Aâ™¯">Aâ™¯</option>
                                <option value="B">B</option>
                                <option value="random" selected>éšæœºæ ¹éŸ³</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-label">
                            è°ƒå¼
                            <span class="info">é€‰æ‹©éŸ³é˜¶çš„ç±»å‹å’Œæ¨¡å¼</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="scaleType">
                                <option value="major">Major</option>
                                <option value="minor">Minor</option>
                                <option value="majorPentatonic">Major Pentatonic</option>
                                <option value="minorPentatonic">Minor Pentatonic</option>
                                <option value="blues">Blues</option>
                                <option value="dorian">Dorian</option>
                                <option value="mixolydian">Mixolydian</option>
                                <option value="random" selected>éšæœºè°ƒå¼</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-label">
                            é¡ºåº
                            <span class="info">é€‰æ‹©éŸ³é˜¶çš„æ¼”å¥é¡ºåº</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn scale-order-btn active" data-value="ordered">é¡ºåº</div>
                            <div class="order-btn scale-order-btn" data-value="random">ä¹±åº</div>
                        </div>
                    </div>
                </div>
                
                <!-- å’Œå¼¦è®¾ç½® -->
                <div class="settings-section chord-settings" style="display: none;">
                    <div class="settings-section-title">
                        <i>ğŸ¶</i> å’Œå¼¦è®¾ç½®
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-label">
                            æ ¹éŸ³
                            <span class="info">é€‰æ‹©å’Œå¼¦çš„æ ¹éŸ³</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="chordRootNote">
                                <option value="C">C</option>
                                <option value="Câ™¯">Câ™¯</option>
                                <option value="D">D</option>
                                <option value="Dâ™¯">Dâ™¯</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="Fâ™¯">Fâ™¯</option>
                                <option value="G">G</option>
                                <option value="Gâ™¯">Gâ™¯</option>
                                <option value="A">A</option>
                                <option value="Aâ™¯">Aâ™¯</option>
                                <option value="B">B</option>
                                <option value="random" selected>éšæœºæ ¹éŸ³</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-label">
                            å’Œå¼¦ç±»å‹
                            <span class="info">é€‰æ‹©è¦ç»ƒä¹ çš„å’Œå¼¦ç±»å‹</span>
                        </div>
                        <div class="chord-type-container">
                            <div class="chord-type-btn active" data-value="major">Major</div>
                            <div class="chord-type-btn active" data-value="minor">Minor</div>
                            <div class="chord-type-btn" data-value="major6">6</div>
                            <div class="chord-type-btn" data-value="minor6">m6</div>
                            <div class="chord-type-btn active" data-value="dominant7">7</div>
                            <div class="chord-type-btn" data-value="major7">Maj7</div>
                            <div class="chord-type-btn" data-value="minor7">m7</div>
                            <div class="chord-type-btn" data-value="minor7b5">m7â™­5</div>
                            <div class="chord-type-btn" data-value="dominant9">9</div>
                            <div class="chord-type-btn" data-value="major9">Maj9</div>
                            <div class="chord-type-btn" data-value="minor9">m9</div>
                            <div class="chord-type-btn" data-value="sus2">sus2</div>
                            <div class="chord-type-btn" data-value="sus4">sus4</div>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-label">
                            é¡ºåº
                            <span class="info">é€‰æ‹©å’Œå¼¦éŸ³ç¬¦çš„æ¼”å¥é¡ºåº</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn chord-order-btn active" data-value="ordered">é¡ºåº</div>
                            <div class="order-btn chord-order-btn" data-value="random">ä¹±åº</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn" id="startBtn">å¼€å§‹ç»ƒä¹ </button>
        </div>
    </div>
    
    <!-- ç»ƒä¹ æ¨¡å¼å…¨å±é¡µé¢ï¼ˆä¿æŒä¸å˜ï¼‰ -->
    <div id="practiceScreen">
        <div class="exercise-container">
            <div class="scale-info">
                <div class="target-interval" id="targetInterval">C Major</div>
            </div>
            
            <div class="sequence-display">
                <div class="sequence-title">è¯·ä¾æ¬¡å¼¹å¥ä»¥ä¸‹éŸ³çº§:</div>
                <div class="sequence-items" id="sequenceDisplay"></div>
            </div>
        </div>
        
        <div class="next-exercise">
            <div class="next-content-wrapper">
                <div class="next-label">ä¸‹ä¸€ä¸ª:</div>
                <div class="next-content" id="nextExercise">-</div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // å‰ä»–æ ‡å‡†è°ƒå¼¦
            const standardTuning = ['E', 'B', 'G', 'D', 'A', 'E'];
            
            // æ‰€æœ‰å¯èƒ½çš„éŸ³çº§
            const intervals = ['1', 'â™­2', '2', 'â™­3', '3', '4', 'â™¯4', '5', 'â™­6', '6', 'â™­7', '7'];
            
            // éŸ³çº§åˆ°åŠéŸ³è·ç¦»çš„æ˜ å°„
            const intervalToSemitones = {
                '1': 0,
                'â™­2': 1,
                '2': 2,
                'â™­3': 3,
                '3': 4,
                '4': 5,
                'â™¯4': 6,
                'â™­5': 6,
                '5': 7,
                'â™­6': 8,
                '6': 9,
                'â™­7': 10,
                '7': 11
            };
            
            // éŸ³ååˆ°åŠéŸ³æ•°çš„æ˜ å°„ï¼ˆC = 0ï¼‰
            const noteToSemitones = {
                'C': 0, 'Câ™¯': 1, 'Dâ™­': 1, 'D': 2, 'Dâ™¯': 3, 'Eâ™­': 3, 'E': 4, 
                'F': 5, 'Fâ™¯': 6, 'Gâ™­': 6, 'G': 7, 'Gâ™¯': 8, 'Aâ™­': 8, 
                'A': 9, 'Aâ™¯': 10, 'Bâ™­': 10, 'B': 11
            };
            
            // éŸ³é˜¶ç±»å‹å®šä¹‰
            const scaleTypes = {
                'major': { name: 'Major', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                'minor': { name: 'Minor', intervals: ['1', '2', 'â™­3', '4', '5', 'â™­6', 'â™­7'] },
                'majorPentatonic': { name: 'Major Pentatonic', intervals: ['1', '2', '3', '5', '6'] },
                'minorPentatonic': { name: 'Minor Pentatonic', intervals: ['1', 'â™­3', '4', '5', 'â™­7'] },
                'blues': { name: 'Blues', intervals: ['1', 'â™­3', '4', 'â™¯4', '5', 'â™­7'] },
                'dorian': { name: 'Dorian', intervals: ['1', '2', 'â™­3', '4', '5', '6', 'â™­7'] },
                'mixolydian': { name: 'Mixolydian', intervals: ['1', '2', '3', '4', '5', '6', 'â™­7'] }
            };
            
            // å’Œå¼¦ç±»å‹å®šä¹‰
            const chordTypes = {
                'major': { name: 'å¤§ä¸‰å’Œå¼¦', intervals: ['1', '3', '5'] },
                'minor': { name: 'å°ä¸‰å’Œå¼¦', intervals: ['1', 'â™­3', '5'] },
                'major6': { name: 'å¤§å…­å’Œå¼¦', intervals: ['1', '3', '5', '6'] },
                'minor6': { name: 'å°å…­å’Œå¼¦', intervals: ['1', 'â™­3', '5', '6'] },
                'dominant7': { name: 'å±ä¸ƒå’Œå¼¦', intervals: ['1', '3', '5', 'â™­7'] },
                'major7': { name: 'å¤§ä¸ƒå’Œå¼¦', intervals: ['1', '3', '5', '7'] },
                'minor7': { name: 'å°ä¸ƒå’Œå¼¦', intervals: ['1', 'â™­3', '5', 'â™­7'] },
                'minor7b5': { name: 'åŠå‡ä¸ƒå’Œå¼¦', intervals: ['1', 'â™­3', 'â™­5', 'â™­7'] },
                'dominant9': { name: 'å±ä¹å’Œå¼¦', intervals: ['1', '3', '5', 'â™­7', '9'] },
                'major9': { name: 'å¤§ä¹å’Œå¼¦', intervals: ['1', '3', '5', '7', '9'] },
                'minor9': { name: 'å°ä¹å’Œå¼¦', intervals: ['1', 'â™­3', '5', 'â™­7', '9'] },
                'sus2': { name: 'æŒ‚äºŒå’Œå¼¦', intervals: ['1', '2', '5'] },
                'sus4': { name: 'æŒ‚å››å’Œå¼¦', intervals: ['1', '4', '5'] }
            };
            
            // å…ƒç´ å¼•ç”¨
            const mainScreen = document.getElementById('mainScreen');
            const practiceScreen = document.getElementById('practiceScreen');
            const targetIntervalEl = document.getElementById('targetInterval');
            const sequenceDisplayEl = document.getElementById('sequenceDisplay');
            const nextExerciseEl = document.getElementById('nextExercise');
            const startBtn = document.getElementById('startBtn');
            const rootNoteEl = document.getElementById('rootNote');
            const scaleTypeEl = document.getElementById('scaleType');
            const chordRootNoteEl = document.getElementById('chordRootNote');
            const statusIndicator = document.getElementById('statusIndicator');
            const shortcutHint = document.getElementById('shortcutHint');
            const metronomeToggleEl = document.getElementById('metronomeToggle');
            const metronomeTempoEl = document.getElementById('metronomeTempo');
            const metronomeTempoValueEl = document.getElementById('metronomeTempoValue');
            
            // é€‰é¡¹å¡å…ƒç´ 
            const settingsTabs = document.querySelectorAll('.settings-tab');
            const scaleSettings = document.querySelector('.scale-settings');
            const chordSettings = document.querySelector('.chord-settings');
            
            // å’Œå¼¦ç±»å‹æŒ‰é’®
            const chordTypeBtns = document.querySelectorAll('.chord-type-btn');
            
            // å±å¹•å”¤é†’é”å˜é‡
            let wakeLock = null;
            
            // è¯·æ±‚å±å¹•å”¤é†’é”
            async function requestWakeLock() {
                try {
                    if ('wakeLock' in navigator) {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('å±å¹•å”¤é†’é”å·²æ¿€æ´»');
                        
                        // ç›‘å¬å”¤é†’é”é‡Šæ”¾
                        wakeLock.addEventListener('release', () => {
                            console.log('å±å¹•å”¤é†’é”å·²é‡Šæ”¾');
                        });
                    }
                } catch (err) {
                    console.error(`æ— æ³•è·å–å±å¹•å”¤é†’é”: ${err.message}`);
                }
            }
            
            // é‡Šæ”¾å±å¹•å”¤é†’é”
            function releaseWakeLock() {
                if (wakeLock !== null) {
                    wakeLock.release();
                    wakeLock = null;
                }
            }
            
            // éŸ³é¢‘åˆ†æå˜é‡
            let audioContext = null;
            let analyser = null;
            let microphone = null;
            let javascriptNode = null;
            let isRecording = false;
            let mediaStream = null;
            
            // ç»ƒä¹ çŠ¶æ€
            let state = {
                score: 0,
                correctCount: 0,
                totalCount: 0,
                accuracy: 0,
                rootNote: '',
                scaleType: '',
                chordType: '',
                currentIntervals: [],
                currentSequence: [],
                currentStep: 0,
                correctPositions: [],
                isAnswered: false,
                timeoutId: null,
                maxFret: 12,
                previousMaxFret: 12,
                isRecording: false,
                sensitivity: 0.5,
                confidenceThreshold: 0.5, // é™ä½ç½®ä¿¡åº¦é˜ˆå€¼ä»¥æé«˜æ£€æµ‹çµæ•åº¦
                noiseLevel: 0.001,
                minVolume: 0.001,
                microphoneInitialized: false,
                pitchBuffer: [],
                bufferSize: 3, // å‡å°‘ç¼“å†²åŒºå¤§å°ä»¥åŠ å¿«å“åº”
                zeroCrossingThreshold: 0.1,
                harmonicWeights: [1.0, 0.8, 0.6],
                nextExerciseInfo: '', // ä¸‹ä¸€ä¸ªç»ƒä¹ çš„æ˜¾ç¤ºä¿¡æ¯
                nextExerciseIntervals: [], // ä¸‹ä¸€ä¸ªç»ƒä¹ çš„éŸ³ç¨‹åºåˆ—
                metronomeEnabled: false, // èŠ‚æ‹å™¨æ˜¯å¦å¯ç”¨
                metronomeTempo: 40, // èŠ‚æ‹å™¨é€Ÿåº¦ (BPM)
                metronomeInterval: null // èŠ‚æ‹å™¨å®šæ—¶å™¨
            };
            
            // å¯åŠ¨éº¦å…‹é£å½•éŸ³
            function startRecording() {
                if (isRecording) return;
                
                try {
                    // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡éº¦å…‹é£ï¼Œç›´æ¥é‡ç”¨
                    if (state.microphoneInitialized && mediaStream) {
                        if (!audioContext) {
                            audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        }
                        
                        analyser = audioContext.createAnalyser();
                        analyser.fftSize = 4096;
                        
                        javascriptNode = audioContext.createScriptProcessor(4096, 1, 1);
                        javascriptNode.onaudioprocess = processAudio;
                        
                        microphone = audioContext.createMediaStreamSource(mediaStream);
                        microphone.connect(analyser);
                        analyser.connect(javascriptNode);
                        javascriptNode.connect(audioContext.destination);
                        
                        isRecording = true;
                        return;
                    }
                    
                    // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 4096;
                    
                    // åˆ›å»ºè„šæœ¬å¤„ç†èŠ‚ç‚¹
                    javascriptNode = audioContext.createScriptProcessor(4096, 1, 1);
                    
                    // è®¾ç½®éŸ³é¢‘å¤„ç†
                    javascriptNode.onaudioprocess = processAudio;
                    
                    // è·å–éº¦å…‹é£è¾“å…¥
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(function(stream) {
                            mediaStream = stream;
                            microphone = audioContext.createMediaStreamSource(stream);
                            microphone.connect(analyser);
                            analyser.connect(javascriptNode);
                            javascriptNode.connect(audioContext.destination);
                            
                            isRecording = true;
                            state.microphoneInitialized = true;
                        })
                        .catch(function(err) {
                            console.error('éº¦å…‹é£è·å–å¤±è´¥:', err);
                        });
                } catch (e) {
                    console.error('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:', e);
                }
            }
            
            // åœæ­¢éº¦å…‹é£å½•éŸ³
            function stopRecording() {
                if (!isRecording) return;
                
                if (javascriptNode) {
                    javascriptNode.disconnect();
                }
                if (analyser) {
                    analyser.disconnect();
                }
                if (microphone) {
                    microphone.disconnect();
                }
                
                isRecording = false;
            }
            
            // å®Œå…¨å…³é—­éº¦å…‹é£ï¼ˆé€€å‡ºåº”ç”¨æ—¶ä½¿ç”¨ï¼‰
            function closeMicrophone() {
                stopRecording();
                
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
                
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
                
                state.microphoneInitialized = false;
            }
            
            // å¤„ç†éŸ³é¢‘æ•°æ®
            function processAudio(event) {
                if (!isRecording || state.isAnswered) return;
                
                const inputData = event.inputBuffer.getChannelData(0);
                const sampleRate = audioContext.sampleRate;
                
                // ä½¿ç”¨PitchFinderåº“çš„YINç®—æ³•æ£€æµ‹éŸ³é«˜
                const detectPitch = Pitchfinder.YIN({ threshold: 0.1 });
                const pitch = detectPitch(inputData);
                
                // è®¡ç®—ç½®ä¿¡åº¦ (PitchFinderä¸ç›´æ¥æä¾›ç½®ä¿¡åº¦ï¼Œæˆ‘ä»¬åŸºäºä¿¡å·å¼ºåº¦ä¼°ç®—)
                const signalStrength = calculateSignalStrength(inputData);
                const confidence = Math.min(1.0, signalStrength * 5); // å°†ä¿¡å·å¼ºåº¦è½¬æ¢ä¸º0-1èŒƒå›´çš„ç½®ä¿¡åº¦
                
                if (pitch && pitch > 0 && confidence >= state.confidenceThreshold) {
                    // åº”ç”¨åŠ æƒç§»åŠ¨å¹³å‡æ»¤æ³¢
                    state.pitchBuffer.push(pitch);
                    if (state.pitchBuffer.length > state.bufferSize) {
                        state.pitchBuffer.shift();
                    }
                    
                    // è®¡ç®—åŠ æƒå¹³å‡å€¼
                    let weightedSum = 0;
                    let weightSum = 0;
                    for (let i = 0; i < state.pitchBuffer.length; i++) {
                        const weight = i + 1;
                        weightedSum += state.pitchBuffer[i] * weight;
                        weightSum += weight;
                    }
                    const smoothedPitch = weightedSum / weightSum;
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ¹é…å½“å‰æ­¥éª¤çš„éŸ³é«˜
                    checkPitchMatch(smoothedPitch, confidence);
                }
            }
            
            // è®¡ç®—ä¿¡å·å¼ºåº¦ä½œä¸ºç½®ä¿¡åº¦çš„ä¼°è®¡
            function calculateSignalStrength(buffer) {
                let sum = 0;
                for (let i = 0; i < buffer.length; i++) {
                    sum += Math.abs(buffer[i]);
                }
                const average = sum / buffer.length;
                return Math.min(1.0, average * 10); // å°†å¹³å‡æŒ¯å¹…è½¬æ¢ä¸º0-1èŒƒå›´
            }
            
            // é¢‘ç‡è½¬æ¢ä¸ºéŸ³ç¬¦åç§°å’Œå…«åº¦
            function frequencyToNoteName(frequency) {
                const A4 = 440;
                const noteNames = ['C', 'Câ™¯', 'D', 'Dâ™¯', 'E', 'F', 'Fâ™¯', 'G', 'Gâ™¯', 'A', 'Aâ™¯', 'B'];
                
                // è®¡ç®—åŠéŸ³è·ç¦»
                const noteNum = 12 * (Math.log2(frequency / A4)) + 69;
                const noteIndex = Math.round(noteNum) % 12;
                const octave = Math.floor(noteNum / 12) - 1;
                
                return {
                    name: noteNames[noteIndex],
                    octave: octave
                };
            }
            
            // è®¡ç®—è°æ³¢æƒé‡
            function getHarmonicWeight(detectedFreq, rootFreq) {
                const rootValue = noteToSemitones[rootFreq];
                const detectedNote = frequencyToNoteName(detectedFreq);
                const semitoneDiff = Math.abs(noteToSemitones[detectedNote.name] - rootValue) % 12;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯åŸºé¢‘æˆ–ä¸»è¦è°æ³¢
                if (semitoneDiff === 0) return state.harmonicWeights[0]; // åŸºé¢‘
                if ([7, 12].includes(semitoneDiff)) return state.harmonicWeights[1]; // äº”åº¦/å…«åº¦
                if ([4, 9].includes(semitoneDiff)) return state.harmonicWeights[2]; // å¤§ä¸‰åº¦/å…­åº¦
                
                return 0; // å¿½ç•¥å…¶ä»–è°æ³¢
            }
            
            // æ£€æŸ¥ä¿¡å·å‘¨æœŸæ€§ï¼ˆé€šè¿‡è¿‡é›¶ç‡ï¼‰
            function isPeriodicSignal(buffer) {
                let zeroCrossings = 0;
                for (let i = 1; i < buffer.length; i++) {
                    if (buffer[i-1] * buffer[i] < 0) {
                        zeroCrossings++;
                    }
                }
                const zeroCrossingRate = zeroCrossings / buffer.length;
                return zeroCrossingRate > state.zeroCrossingThreshold;
            }

            // æ£€æŸ¥æ£€æµ‹åˆ°çš„éŸ³é«˜æ˜¯å¦åŒ¹é…å½“å‰æ­¥éª¤çš„ç›®æ ‡éŸ³é«˜
            function checkPitchMatch(detectedPitch, confidence) {
                if (state.isAnswered || confidence < state.confidenceThreshold) return;
                
                const currentInterval = state.currentSequence[state.currentStep];
                const rootValue = noteToSemitones[state.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;
                
                // è®¡ç®—ç›®æ ‡é¢‘ç‡ï¼ˆä¸­å¤®Cé™„è¿‘çš„é¢‘ç‡ï¼‰
                const targetFrequency = 440 * Math.pow(2, (targetSemitone - 9) / 12);
                
                // è®¡ç®—éŸ³åˆ†å·®ï¼ˆ1åŠéŸ³ = 100éŸ³åˆ†ï¼‰
                const cents = 1200 * Math.log2(detectedPitch / targetFrequency);
                
                // æ›´æ–°å®æ—¶éŸ³é«˜æ˜¾ç¤º
                updatePitchDisplay(detectedPitch, cents, confidence);
                
                // æ£€æŸ¥æ˜¯å¦åœ¨å…è®¸çš„è¯¯å·®èŒƒå›´å†…ï¼ˆÂ±20éŸ³åˆ†ï¼‰
                // å¤„ç†å…«åº¦é—®é¢˜ï¼Œä»»ä½•å…«åº¦çš„æ­£ç¡®éŸ³é«˜éƒ½åº”è¯¥è¢«æ¥å—
                const centsMod = Math.abs(cents) % 1200;
                const adjustedCents = centsMod > 600 ? 1200 - centsMod : centsMod;
                
                if (adjustedCents <= 20) {
                    // æ­£ç¡®åŒ¹é…
                    handleCorrectAnswer();
                }
            }
            
            // æ›´æ–°å®æ—¶éŸ³é«˜æ˜¾ç¤º
            function updatePitchDisplay(frequency, cents, confidence) {
                const pitchDisplay = document.getElementById('pitchDisplay');
                if (!pitchDisplay) return;
                
                const note = frequencyToNoteName(frequency);
                const centsMod = cents % 1200;
                const adjustedCents = centsMod > 600 ? centsMod - 1200 : centsMod;
                
                pitchDisplay.innerHTML = `
                    <div>éŸ³é«˜: ${note.name}${note.octave} (${Math.round(frequency)}Hz)</div>
                    <div>éŸ³åˆ†å·®: ${adjustedCents > 0 ? '+' : ''}${Math.round(adjustedCents)}</div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: ${Math.round(confidence * 100)}%"></div>
                    </div>
                `;
                
                // æ ¹æ®éŸ³åˆ†å·®è®¾ç½®é¢œè‰²
                if (Math.abs(adjustedCents) <= 20) {
                    pitchDisplay.classList.add('in-tune');
                    pitchDisplay.classList.remove('out-of-tune');
                } else {
                    pitchDisplay.classList.add('out-of-tune');
                    pitchDisplay.classList.remove('in-tune');
                }
            }
            
            // å¤„ç†æ­£ç¡®ç­”æ¡ˆ
            function handleCorrectAnswer() {
                // æ ‡è®°å½“å‰æ­¥éª¤ä¸ºå·²æ’­æ”¾
                const sequenceItems = document.querySelectorAll('.sequence-item');
                if (sequenceItems[state.currentStep]) {
                    sequenceItems[state.currentStep].classList.remove('current');
                    sequenceItems[state.currentStep].classList.add('played');
                }
                
                // æ›´æ–°çŠ¶æ€
                state.correctCount++;
                state.totalCount++;
                state.score += 10;
                state.currentStep++;
                
                // æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰æ­¥éª¤
                if (state.currentStep >= state.currentSequence.length) {
                    // å®Œæˆç»ƒä¹ 
                    state.isAnswered = true;
                    
                    // æçŸ­å»¶è¿Ÿåç”Ÿæˆæ–°ç»ƒä¹ ï¼Œä¿æŒéº¦å…‹é£æŒç»­è¿è¡Œ
                    setTimeout(() => {
                        // ä¿ç•™éŸ³é«˜ç¼“å†²åŒºå†…å®¹ï¼Œä¿æŒè¯†åˆ«è¿ç»­æ€§
                        // ä»…é‡ç½®å¿…è¦çš„ç»ƒä¹ çŠ¶æ€
                        state.currentStep = 0;
                        state.isAnswered = false;
                        
                        // ç”Ÿæˆæ–°ç»ƒä¹ 
                        generateExercise();
                    }, 300); // ç¼©çŸ­å»¶è¿Ÿåˆ°300ms
                } else {
                    // é«˜äº®æ˜¾ç¤ºä¸‹ä¸€ä¸ªæ­¥éª¤
                    if (sequenceItems[state.currentStep]) {
                        sequenceItems[state.currentStep].classList.add('current');
                    }
                }
            }
            
            // é¢„ç”Ÿæˆä¸‹ä¸€ä¸ªç»ƒä¹ 
            function generateNextExercise() {
                // è·å–å½“å‰æ¿€æ´»çš„é€‰é¡¹å¡
                const activeTab = document.querySelector('.settings-tab.active').dataset.tab;
                
                if (activeTab === 'scale') {
                    // ç¡®å®šæ ¹éŸ³
                    let rootNote = rootNoteEl.value;
                    if (rootNote === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2 && n !== 'Dâ™­' && n !== 'Eâ™­' && n !== 'Gâ™­' && n !== 'Aâ™­' && n !== 'Bâ™­');
                        rootNote = notes[Math.floor(Math.random() * notes.length)];
                    }
                    
                    // ç¡®å®šè°ƒå¼
                    let scaleType = scaleTypeEl.value;
                    if (scaleType === 'random') {
                        const types = Object.keys(scaleTypes);
                        scaleType = types[Math.floor(Math.random() * types.length)];
                    }
                    
                    // ç¡®å®šé¡ºåº
                    const activeOrderBtn = document.querySelector('.scale-order-btn.active');
                    const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                    
                    // è·å–éŸ³ç¨‹åºåˆ—
                    let intervals = [...scaleTypes[scaleType].intervals];
                    if (order === 'random') {
                        // æ‰“ä¹±é¡ºåºï¼Œä½†ä¿æŒç¬¬ä¸€ä¸ªéŸ³æ˜¯ä¸»éŸ³
                        const firstInterval = intervals[0];
                        const otherIntervals = intervals.slice(1);
                        for (let i = otherIntervals.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                        }
                        intervals = [firstInterval, ...otherIntervals];
                    }
                    
                    // ä¿å­˜ä¸‹ä¸€ä¸ªç»ƒä¹ ä¿¡æ¯
                    state.nextExerciseInfo = `${rootNote} ${scaleTypes[scaleType].name}`;
                    state.nextExerciseIntervals = intervals;
                } else {
                    // ç¡®å®šæ ¹éŸ³
                    let rootNote = chordRootNoteEl.value;
                    if (rootNote === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2 && n !== 'Dâ™­' && n !== 'Eâ™­' && n !== 'Gâ™­' && n !== 'Aâ™­' && n !== 'Bâ™­');
                        rootNote = notes[Math.floor(Math.random() * notes.length)];
                    }
                    
                    // ç¡®å®šå’Œå¼¦ç±»å‹
                    const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                    let chordType = 'major';
                    if (activeChordTypes.length > 0) {
                        const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                        chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                    }
                    
                    // ç¡®å®šé¡ºåº
                    const activeOrderBtn = document.querySelector('.chord-order-btn.active');
                    const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                    
                    // è·å–éŸ³ç¨‹åºåˆ—
                    let intervals = [...chordTypes[chordType].intervals];
                    if (order === 'random') {
                        // æ‰“ä¹±é¡ºåº
                        for (let i = intervals.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [intervals[i], intervals[j]] = [intervals[j], intervals[i]];
                        }
                    }
                    
                    // ç”Ÿæˆå’Œå¼¦ç¬¦å·
                    const chordSymbol = chordType === 'major' ? '' : 
                                      chordType === 'minor' ? 'm' : 
                                      chordType === 'dominant7' ? '7' : 
                                      chordType === 'major7' ? 'maj7' : 
                                      chordType === 'minor7' ? 'm7' : 
                                      chordType === 'minor7b5' ? 'm7â™­5' :
                                      chordType === 'dominant9' ? '9' :
                                      chordType === 'major9' ? 'maj9' :
                                      chordType === 'minor9' ? 'm9' :
                                      chordType === 'sus2' ? 'sus2' : 'sus4';
                    
                    // ä¿å­˜ä¸‹ä¸€ä¸ªç»ƒä¹ ä¿¡æ¯
                    state.nextExerciseInfo = `${rootNote}${chordSymbol}`;
                    state.nextExerciseIntervals = intervals;
                }
                
                // æ›´æ–°æ˜¾ç¤º
                updateNextExerciseDisplay();
            }
            
            // æ›´æ–°ä¸‹ä¸€ä¸ªç»ƒä¹ æ˜¾ç¤º
            function updateNextExerciseDisplay() {
                if (state.nextExerciseInfo && state.nextExerciseIntervals.length > 0) {
                    nextExerciseEl.innerHTML = `${state.nextExerciseInfo}<br><span style="font-size: 14px; color: #94a3b8;">${state.nextExerciseIntervals.join(' ')}</span>`;
                }
            }
            
            // ç”Ÿæˆæ–°çš„ç»ƒä¹ é¢˜ç›®
            function generateExercise() {
                // æ¸…ç©ºéŸ³é«˜ç¼“å†²åŒº
                state.pitchBuffer = [];
                
                state.isAnswered = false;
                state.currentStep = 0;
                
                if (state.timeoutId) {
                    clearTimeout(state.timeoutId);
                    state.timeoutId = null;
                }
                
                // ä½¿ç”¨é¢„ç”Ÿæˆçš„ä¸‹ä¸€ä¸ªç»ƒä¹ 
                if (state.nextExerciseInfo && state.nextExerciseIntervals.length > 0) {
                    const activeTab = document.querySelector('.settings-tab.active').dataset.tab;
                    
                    if (activeTab === 'scale') {
                        // è§£æéŸ³é˜¶ä¿¡æ¯
                        const parts = state.nextExerciseInfo.split(' ');
                        state.rootNote = parts[0];
                        state.scaleType = Object.keys(scaleTypes).find(key => scaleTypes[key].name === parts[1]);
                        state.currentIntervals = [...state.nextExerciseIntervals];
                        targetIntervalEl.textContent = state.nextExerciseInfo;
                    } else {
                        // è§£æå’Œå¼¦ä¿¡æ¯
                        const chordMatch = state.nextExerciseInfo.match(/([A-G][â™¯â™­]?)(.*)/);
                        state.rootNote = chordMatch[1];
                        
                        // æ ¹æ®å’Œå¼¦ç¬¦å·ç¡®å®šå’Œå¼¦ç±»å‹
                        const chordSymbol = chordMatch[2];
                        state.chordType = chordSymbol === '' ? 'major' : 
                                         chordSymbol === 'm' ? 'minor' : 
                                         chordSymbol === '7' ? 'dominant7' : 
                                         chordSymbol === 'maj7' ? 'major7' : 
                                         chordSymbol === 'm7' ? 'minor7' : 
                                         chordSymbol === 'sus2' ? 'sus2' : 'sus4';
                                         
                        state.currentIntervals = [...state.nextExerciseIntervals];
                        targetIntervalEl.textContent = state.nextExerciseInfo;
                    }
                    
                    // æ˜¾ç¤ºåºåˆ—
                    displaySequence();
                } else {
                    // æ²¡æœ‰é¢„ç”Ÿæˆçš„ç»ƒä¹ ï¼Œç”Ÿæˆæ–°çš„
                    const activeTab = document.querySelector('.settings-tab.active').dataset.tab;
                    if (activeTab === 'scale') {
                        generateScaleExercise();
                    } else {
                        generateChordExercise();
                    }
                }
                
                // é¢„ç”Ÿæˆä¸‹ä¸€ä¸ªç»ƒä¹ 
                generateNextExercise();
            }
            
            // ç”ŸæˆéŸ³é˜¶ç»ƒä¹ 
            function generateScaleExercise() {
                // ç¡®å®šæ ¹éŸ³
                let rootNote = rootNoteEl.value;
                if (rootNote === 'random') {
                    const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2 && n !== 'Dâ™­' && n !== 'Eâ™­' && n !== 'Gâ™­' && n !== 'Aâ™­' && n !== 'Bâ™­');
                    rootNote = notes[Math.floor(Math.random() * notes.length)];
                }
                state.rootNote = rootNote;
                
                // ç¡®å®šè°ƒå¼
                let scaleType = scaleTypeEl.value;
                if (scaleType === 'random') {
                    const types = Object.keys(scaleTypes);
                    scaleType = types[Math.floor(Math.random() * types.length)];
                }
                state.scaleType = scaleType;
                
                // è·å–éŸ³é˜¶éŸ³ç¨‹
                state.currentIntervals = [...scaleTypes[scaleType].intervals];
                
                // ç¡®å®šé¡ºåº
                const activeScaleOrderBtn = document.querySelector('.scale-order-btn.active');
                const order = activeScaleOrderBtn ? activeScaleOrderBtn.dataset.value : 'ordered';
                if (order === 'random') {
                    // æ‰“ä¹±éŸ³é˜¶é¡ºåºï¼Œä½†ä¿æŒç¬¬ä¸€ä¸ªéŸ³æ˜¯ä¸»éŸ³
                    const firstInterval = state.currentIntervals[0];
                    const otherIntervals = state.currentIntervals.slice(1);
                    for (let i = otherIntervals.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                    }
                    state.currentIntervals = [firstInterval, ...otherIntervals];
                }
                
                // è®¾ç½®æ˜¾ç¤ºæ ‡é¢˜
                targetIntervalEl.textContent = `${rootNote} ${scaleTypes[scaleType].name}`;
                
                // æ˜¾ç¤ºéŸ³é˜¶åºåˆ—
                displaySequence();
            }
            
            // ç”Ÿæˆå’Œå¼¦ç»ƒä¹ 
            function generateChordExercise() {
                // ç¡®å®šæ ¹éŸ³
                let rootNote = chordRootNoteEl.value;
                if (rootNote === 'random') {
                    const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2 && n !== 'Dâ™­' && n !== 'Eâ™­' && n !== 'Gâ™­' && n !== 'Aâ™­' && n !== 'Bâ™­');
                    rootNote = notes[Math.floor(Math.random() * notes.length)];
                }
                state.rootNote = rootNote;
                
                // ç¡®å®šå’Œå¼¦ç±»å‹
                const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                if (activeChordTypes.length === 0) {
                    // å¦‚æœæ²¡æœ‰é€‰æ‹©ä»»ä½•å’Œå¼¦ç±»å‹ï¼Œé»˜è®¤é€‰æ‹©å¤§ä¸‰å’Œå¼¦
                    state.chordType = 'major';
                } else {
                    const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                    state.chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                }
                
                // è·å–å’Œå¼¦éŸ³ç¨‹
                state.currentIntervals = [...chordTypes[state.chordType].intervals];
                
                // ç¡®å®šé¡ºåº
                const activeChordOrderBtn = document.querySelector('.chord-order-btn.active');
                const order = activeChordOrderBtn ? activeChordOrderBtn.dataset.value : 'ordered';
                if (order === 'random') {
                    // æ‰“ä¹±å’Œå¼¦éŸ³é¡ºåº
                    for (let i = state.currentIntervals.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [state.currentIntervals[i], state.currentIntervals[j]] = [state.currentIntervals[j], state.currentIntervals[i]];
                    }
                }
                
                // è®¾ç½®æ˜¾ç¤ºæ ‡é¢˜
                const chordSymbol = `${rootNote}${state.chordType === 'major' ? '' : state.chordType === 'minor' ? 'm' : state.chordType === 'dominant7' ? '7' : state.chordType === 'major7' ? 'maj7' : state.chordType === 'minor7' ? 'm7' : state.chordType === 'sus2' ? 'sus2' : 'sus4'}`;
                targetIntervalEl.textContent = chordSymbol;
                
                // æ˜¾ç¤ºå’Œå¼¦åºåˆ—
                displaySequence();
            }
            
            // æ˜¾ç¤ºéŸ³é˜¶/å’Œå¼¦åºåˆ—
            function displaySequence() {
                sequenceDisplayEl.innerHTML = '';
                state.currentSequence = [];
                
                state.currentIntervals.forEach((interval, index) => {
                    const span = document.createElement('div');
                    span.className = 'sequence-item';
                    if (index === 0) span.classList.add('current');
                    span.textContent = interval;
                    span.dataset.index = index;
                    sequenceDisplayEl.appendChild(span);
                    state.currentSequence.push(interval);
                });
            }
            
            // å¯åŠ¨èŠ‚æ‹å™¨
            function startMetronome() {
                if (state.metronomeInterval) {
                    stopMetronome(); // ç¡®ä¿å…ˆåœæ­¢ä¹‹å‰çš„èŠ‚æ‹å™¨
                }
                
                if (!state.metronomeEnabled) return;
                
                // è®¡ç®—èŠ‚æ‹é—´éš”ï¼ˆæ¯«ç§’ï¼‰
                const beatInterval = 60000 / state.metronomeTempo;
                
                // è®¾ç½®CSSå˜é‡ä»¥æ§åˆ¶é—ªçƒé€Ÿåº¦
                document.documentElement.style.setProperty('--metronome-speed', `${beatInterval}ms`);
                
                // æ·»åŠ é—ªçƒåŠ¨ç”»ç±»
                if (practiceScreen.style.display === 'flex') {
                    practiceScreen.classList.add('metronome-active');
                }
                
                // å¯åŠ¨èŠ‚æ‹å™¨å®šæ—¶å™¨
                state.metronomeInterval = setInterval(() => {
                    // è¿™é‡Œå¯ä»¥æ·»åŠ å£°éŸ³æ•ˆæœï¼ˆå¦‚æœéœ€è¦ï¼‰
                }, beatInterval);
            }
            
            // åœæ­¢èŠ‚æ‹å™¨
            function stopMetronome() {
                if (state.metronomeInterval) {
                    clearInterval(state.metronomeInterval);
                    state.metronomeInterval = null;
                }
                
                // ç§»é™¤é—ªçƒåŠ¨ç”»ç±»
                practiceScreen.classList.remove('metronome-active');
            }
            
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            function initEventListeners() {
                // èŠ‚æ‹å™¨å¼€å…³äº‹ä»¶
                metronomeToggleEl.addEventListener('change', function() {
                    state.metronomeEnabled = this.checked;
                    if (state.metronomeEnabled && practiceScreen.style.display === 'flex') {
                        startMetronome();
                    } else {
                        stopMetronome();
                    }
                });
                
                // èŠ‚æ‹å™¨é€Ÿåº¦æ»‘å—äº‹ä»¶
                metronomeTempoEl.addEventListener('input', function() {
                    state.metronomeTempo = parseInt(this.value);
                    metronomeTempoValueEl.textContent = state.metronomeTempo;
                    
                    // å¦‚æœèŠ‚æ‹å™¨æ­£åœ¨è¿è¡Œï¼Œé‡æ–°å¯åŠ¨ä»¥åº”ç”¨æ–°é€Ÿåº¦
                    if (state.metronomeEnabled && state.metronomeInterval) {
                        startMetronome();
                    }
                });
                
                // å¼€å§‹ç»ƒä¹ æŒ‰é’®
                startBtn.addEventListener('click', function() {
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    updateStatusIndicator('æ­£åœ¨å¯åŠ¨éº¦å…‹é£...', 'recording');
                    
                    setTimeout(() => {
                        // éšè—ä¸»å±å¹•ï¼Œæ˜¾ç¤ºç»ƒä¹ å±å¹•å’ŒéŸ³é«˜æ˜¾ç¤º
                        mainScreen.style.display = 'none';
                        practiceScreen.style.display = 'flex';
                        document.getElementById('pitchDisplay').style.display = 'block';
                        
                        // è¯·æ±‚å±å¹•å”¤é†’é”
                        requestWakeLock();
                        
                        // é‡ç½®çŠ¶æ€
                        state.nextExerciseInfo = '';
                        state.nextExerciseIntervals = [];
                        
                        // ç”Ÿæˆç¬¬ä¸€ä¸ªç»ƒä¹ 
                        generateExercise();
                        
                        // å¯åŠ¨éº¦å…‹é£
                        startRecording();
                        
                        // å¦‚æœèŠ‚æ‹å™¨å·²å¯ç”¨ï¼Œåˆ™å¯åŠ¨èŠ‚æ‹å™¨
                        if (state.metronomeEnabled) {
                            startMetronome();
                        }
                        
                        updateStatusIndicator('å½•éŸ³ä¸­...', 'recording');
                    }, 500);
                });
                
                // é€‰é¡¹å¡åˆ‡æ¢
                settingsTabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        const tabName = this.dataset.tab;
                        
                        // æ›´æ–°æ¿€æ´»çš„é€‰é¡¹å¡
                        settingsTabs.forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        
                        // æ˜¾ç¤ºå¯¹åº”çš„è®¾ç½®å†…å®¹
                        if (tabName === 'scale') {
                            scaleSettings.style.display = 'block';
                            chordSettings.style.display = 'none';
                        } else {
                            scaleSettings.style.display = 'none';
                            chordSettings.style.display = 'block';
                        }
                    });
                });
                
                // å’Œå¼¦ç±»å‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                chordTypeBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        this.classList.toggle('active');
                        
                        // æ›´æ–°ä¸‹ä¸€ä¸ªç»ƒä¹ ä¿¡æ¯
                        generateNextExerciseInfo();
                    });
                });
                
                // éŸ³é˜¶é¡ºåºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const scaleOrderBtns = document.querySelectorAll('.scale-order-btn');
                scaleOrderBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
                        scaleOrderBtns.forEach(b => b.classList.remove('active'));
                        // æ¿€æ´»å½“å‰æŒ‰é’®
                        this.classList.add('active');
                    });
                });
                
                // å’Œå¼¦é¡ºåºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const chordOrderBtns = document.querySelectorAll('.chord-order-btn');
                chordOrderBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
                        chordOrderBtns.forEach(b => b.classList.remove('active'));
                        // æ¿€æ´»å½“å‰æŒ‰é’®
                        this.classList.add('active');
                    });
                });
                
                // ç‚¹å‡»ç»ƒä¹ å±å¹•è¿”å›ä¸»é¡µé¢
                practiceScreen.addEventListener('click', function() {
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    updateStatusIndicator('æ­£åœ¨åœæ­¢å½•éŸ³...', 'ready');
                    
                    setTimeout(() => {
                        // åœæ­¢éº¦å…‹é£
                        stopRecording();
                        
                        // åœæ­¢èŠ‚æ‹å™¨
                        stopMetronome();
                        
                        // é‡Šæ”¾å±å¹•å”¤é†’é”
                        releaseWakeLock();
                        
                        // éšè—ç»ƒä¹ å±å¹•å’ŒéŸ³é«˜æ˜¾ç¤ºï¼Œæ˜¾ç¤ºä¸»å±å¹•
                        practiceScreen.style.display = 'none';
                        document.getElementById('pitchDisplay').style.display = 'none';
                        mainScreen.style.display = 'block';
                        
                        updateStatusIndicator('å‡†å¤‡å°±ç»ª', 'ready');
                    }, 300);
                });
                
                // é¡µé¢å…³é—­æ—¶å®Œå…¨å…³é—­éº¦å…‹é£
                window.addEventListener('beforeunload', function() {
                    closeMicrophone();
                });
            }
            
            // åˆå§‹åŒ–åº”ç”¨
            function initApp() {
                // æ£€æŸ¥PitchFinderåº“æ˜¯å¦åŠ è½½æˆåŠŸ
                if (typeof Pitchfinder === 'undefined') {
                    console.error('PitchFinderåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    alert('éŸ³é«˜æ£€æµ‹åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢');
                } else {
                    console.log('PitchFinderåº“åŠ è½½æˆåŠŸ');
                }
                
                initEventListeners();
                initKeyboardShortcuts();
            }
            
            // åˆå§‹åŒ–é”®ç›˜å¿«æ·é”®
            function initKeyboardShortcuts() {
                document.addEventListener('keydown', function(e) {
                    // ESCé”®è¿”å›ä¸»èœå•
                    if (e.key === 'Escape' && practiceScreen.style.display === 'flex') {
                        practiceScreen.click();
                    }
                    
                    // ç©ºæ ¼é”®é‡æ–°å¼€å§‹å½“å‰ç»ƒä¹ 
                    if (e.key === ' ' && practiceScreen.style.display === 'flex') {
                        generateExercise();
                    }
                });
            }
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            function updateStatusIndicator(status, type = 'ready') {
                statusIndicator.textContent = status;
                statusIndicator.className = `status-indicator status-${type}`;
            }
            
            // å¯åŠ¨åº”ç”¨
            initApp();
        });
    </script>
</body>
</html>
