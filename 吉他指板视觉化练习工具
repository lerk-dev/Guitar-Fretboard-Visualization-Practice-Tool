<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âêâ‰ªñÊåáÊùøËßÜËßâÂåñÁªÉ‰π†Â∑•ÂÖ∑v0.1</title>
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a3a, #0d1b2a);
            color: #e0e0e0;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background-color: rgba(40, 40, 50, 0.9);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 152, 0, 0.3);
            padding-bottom: 15px;
        }
        
        h1 {
            color: #3a9fc4;
            margin-bottom: 10px;
            font-size: 28px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .instructions {
            color: #b0b0b0;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .settings-panel {
            background: linear-gradient(to right, rgba(51, 51, 51, 0.8), rgba(60, 60, 70, 0.8));
            border-radius: 12px;
            padding: 0;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .settings-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(40, 40, 50, 0.8);
        }
        
        .settings-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        
        .settings-tab.active {
            color: #3a9fc4;
            border-bottom: 2px solid #3a9fc4;
            background: rgba(128, 128, 128, 0.2);
        }
        
        .settings-content {
            padding: 12px;
        }
        
        .settings-section {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #3a9fc4;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }
        
        .settings-section-title i {
            margin-right: 10px;
            font-size: 20px;
        }
        
        .settings-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .settings-label {
            font-size: 14px;
            color: #e0e0e0;
            margin-bottom: 6px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .settings-label .info {
            color: #888;
            font-size: 14px;
        }
        
        .select-wrapper {
            position: relative;
            width: 100%;
        }
        
        .select-wrapper::after {
            content: "‚ñº";
            font-size: 10px;
            color: #808080;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        
        select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #2c2c3c;
            color: #fff;
            font-size: 14px;
            appearance: none;
            -webkit-appearance: none;
            outline: none;
            transition: all 0.2s;
        }
        
        select:focus {
            border-color: #ffffff;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }
        
        .switch-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
        }
        
        .switch-label {
            font-size: 14px;
            color: #e0e0e0;
            font-weight: 500;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 30px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #3a9fc4;
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        .chord-type-container {
            display: grid;
            grid-template-columns: repeat(4, minmax(min-content, 1fr));
            gap: 8px;
            width: 100%;
        }
        
        
        .chord-type-btn {
            padding: 8px 6px;
            border-radius: 6px;
            border: 1px solid #555;
            background-color: #2c2c3c;
            color: #aaa;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 0;
            white-space: nowrap;
        }

        @media (max-width: 480px) {
            .chord-type-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .chord-type-btn.active {
            background-color: rgba(58, 159, 196, 0.2);
            color: #3a9fc4;
            border-color: #3a9fc4;
        }
        
        .order-btn-container {
            display: flex;
            gap: 8px;
            width: 100%;
        }
        
        .order-btn {
            flex: 1;
            padding: 10px 8px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #2c2c3c;
            color: #aaa;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .order-btn.active {
            background-color: rgba(58, 159, 196, 0.2);
            color: #3a9fc4;
            border-color: #3a9fc4;
        }
        
        .btn {
            padding: 18px 32px;
            border: none;
            border-radius: 16px;
            background: linear-gradient(to right, #4fc3f7, #29b6f6);
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            flex: 1;
            max-width: 280px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }
        
        .btn:disabled {
            background: linear-gradient(to right, #555, #666);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (min-width: 768px) {
            .chord-type-container {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .settings-row {
                flex-direction: row;
                align-items: center;
            }
            
            .settings-label {
                min-width: 100px;
                margin-bottom: 0;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .btn {
                padding: 16px 24px;
                font-size: 16px;
            }
            
            .settings-section-title {
                font-size: 16px;
            }
            
            .settings-tab {
                padding: 14px 12px;
                font-size: 14px;
            }
        }

        #practiceScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            backdrop-filter: blur(10px);
            transition: background-color 0.1s ease;
        }
        
        #practiceScreen.metronome-active {
            /* ËäÇÊãçÂô®ÊøÄÊ¥ªÁä∂ÊÄÅÁöÑÂü∫Á°ÄÊ†∑Âºè */
            transition: background-color 0.1s ease;
        }
        

        
        .exercise-container {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.95), rgba(71, 85, 105, 0.95));
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            text-align: center;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            max-width: 800px;
            backdrop-filter: blur(10px);
        }
        
        .scale-info {
            margin-bottom: 24px;
        }
        
        .target-interval {
            font-size: 36px;
            font-weight: 700;
            color: #38bdf8;
            margin: 12px 0;
            text-shadow: 0 4px 8px rgba(56, 189, 248, 0.3);
            letter-spacing: -0.5px;
        }
        
        .sequence-display {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .sequence-title {
            font-size: 16px;
            color: #94a3b8;
            margin-bottom: 16px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .sequence-items {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 6px;
            padding: 10px 0;
            margin: 0 auto;
            width: 100%;
        }
        
        .sequence-item {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 700;
            color: #ff8a00;
            transition: all 0.3s ease;
            padding: 8px;
            border-radius: 6px;
            background: rgba(51, 65, 85, 0.9);
            min-width: 36px;
            height: 36px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            flex: 0 1 auto;
        }
        
        .sequence-item.played {
            color: #64748b !important;
            background: rgba(30, 41, 59, 0.6) !important;
            box-shadow: none !important;
            border-color: rgba(100, 116, 139, 0.3);
            transform: scale(0.95);
        }
        
        .sequence-item.current {
            color: #38bdf8;
            background: rgba(56, 189, 248, 0.15);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            border-color: rgba(56, 189, 248, 0.3);
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(56, 189, 248, 0.6);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            }
        }
        
        .next-exercise {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-top: 24px;
            width: 100%;
            max-width: 700px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        .next-label {
            font-size: 14px;
            color: #94a3b8;
            white-space: nowrap;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .next-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        
        .next-content {
            font-size: 16px;
            color: #ff8a00;
            font-weight: 600;
            text-align: center;
        }
        
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1001;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-recording {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .status-ready {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .shortcut-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .shortcut-key {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            margin: 0 4px;
            font-weight: 600;
            color: #ff8a00;
        }
        
        .pitch-display {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.8);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .pitch-display.in-tune {
            border-color: rgba(34, 197, 94, 0.5);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }
        
        .pitch-display.out-of-tune {
            border-color: rgba(239, 68, 68, 0.5);
        }
        
        .confidence-bar {
            margin-top: 8px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: #38bdf8;
            border-radius: 2px;
            transition: width 0.2s ease;
        }
        

        
        .device-info {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        .gain-control {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .gain-control input {
            flex: 1;
        }
        
        .gain-value {
            min-width: 40px;
            text-align: right;
        }
        
        .usb-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #22c55e;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes metronomeFlash {
            0% { background-color: rgba(58, 159, 196, 0); }
            50% { background-color: rgba(58, 159, 196, 0.3); }
            100% { background-color: rgba(58, 159, 196, 0); }
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes metronomeFlash {
            0% { background-color: rgba(58, 159, 196, 0); }
            50% { background-color: rgba(58, 159, 196, 0.3); }
            100% { background-color: rgba(58, 159, 196, 0); }
        }

        .metronome-flash {
            animation: metronomeFlash 0.2s ease;
        }
        #practiceScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            backdrop-filter: blur(10px);
            transition: background-color 0.3s ease;
        }
        
        #practiceScreen.metronome-flash {
            background: linear-gradient(135deg, #1e3a5f, #2d4a7a);
            transition: background-color 0.1s ease;
        }

        /* ÂÖ∂‰ªñÊ†∑Âºè‰øùÊåÅ‰∏çÂèò... */
        
        @keyframes metronomeFlash {
            0% { 
                background: linear-gradient(135deg, #0f172a, #1e293b);
            }
            20% { 
                background: linear-gradient(135deg, #1e3a5f, #2d4a7a);
            }
            100% { 
                background: linear-gradient(135deg, #0f172a, #1e293b);
            }
        }

        .metronome-flash {
            animation: metronomeFlash 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- ÂÖ∂‰ªñHTMLÂÜÖÂÆπ‰øùÊåÅ‰∏çÂèò... -->
        <div class="status-indicator status-ready" id="statusIndicator">ÂáÜÂ§áÂ∞±Áª™</div>
    
    <!-- ÈîÆÁõòÂø´Êç∑ÈîÆÊèêÁ§∫ -->
    <div class="shortcut-hint" id="shortcutHint">
        Êåâ <span class="shortcut-key">ESC</span> ËøîÂõû‰∏ªËèúÂçï
    </div>
    
    <!-- ÂÆûÊó∂Èü≥È´òÊòæÁ§∫ -->
    <div class="pitch-display" id="pitchDisplay" style="display: none;">
        <div>Èü≥È´ò: --</div>
        <div>Èü≥ÂàÜÂ∑Æ: 0</div>
        <div class="confidence-bar">
            <div class="confidence-fill" style="width: 0%"></div>
        </div>
    </div>
    
    <div class="container" id="mainScreen">
        <div class="header">
            <h1>üé∏ Âêâ‰ªñÈü≥Èò∂‰∏éÂíåÂº¶ÁªÉ‰π†Â∑•ÂÖ∑ - ÊîØÊåÅUSBÂ£∞Âç°</h1>
            <div class="instructions">
                ÊîØÊåÅÂêâ‰ªñÈÄöËøáUSBÂ£∞Âç°ËæìÂÖ•ËøõË°åÈü≥È´òÊ£ÄÊµã„ÄÇËøûÊé•ÊÇ®ÁöÑUSBÈü≥È¢ëÊé•Âè£ÂêéÔºåÈÄâÊã©ÂØπÂ∫îÁöÑËÆæÂ§áÂç≥ÂèØÂºÄÂßãÁªÉ‰π†„ÄÇ
            </div>
        </div>
        
        <!-- ËÆæÁΩÆÈù¢Êùø -->
        <div class="settings-panel">
            <!-- ÈÄâÈ°πÂç°ÂØºËà™ -->
            <div class="settings-tabs">
                <div class="settings-tab active" data-tab="scale">Èü≥Èò∂ÁªÉ‰π†</div>
                <div class="settings-tab" data-tab="chord">ÂíåÂº¶ÁªÉ‰π†</div>
                <div class="settings-tab" data-tab="device">ËÆæÁΩÆ</div>
            </div>
            
            <!-- ËÆæÁΩÆÂÜÖÂÆπÂå∫Âüü -->
            <div class="settings-content">

                
                <!-- ÂíåÂº¶ËÆæÁΩÆ -->
                <div class="settings-section chord-settings" style="display: none;">
                    <div class="settings-section-title">
                        <i>üé∂</i> ÂíåÂº¶ËÆæÁΩÆ
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-label">
                            Ê†πÈü≥
                            <span class="info">ÈÄâÊã©ÂíåÂº¶ÁöÑÊ†πÈü≥</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="chordRootNote">
                                <option value="C">C</option>
                                <option value="C‚ôØ">C#/Db</option>
                                <option value="D">D</option>
                                <option value="D‚ôØ">D#/Eb</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="F‚ôØ">F#/Gb</option>
                                <option value="G">G</option>
                                <option value="G‚ôØ">G#/Ab</option>
                                <option value="A">A</option>
                                <option value="A‚ôØ">A#/Bb</option>
                                <option value="B">B</option>
                                <option value="random" selected>ÈöèÊú∫Ê†πÈü≥</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-label">
                            ÂíåÂº¶Á±ªÂûã
                            <span class="info">ÈÄâÊã©Ë¶ÅÁªÉ‰π†ÁöÑÂíåÂº¶Á±ªÂûã</span>
                        </div>
                        <div class="chord-type-container">
                            <div class="chord-type-btn active" data-value="major">Major</div>
                            <div class="chord-type-btn active" data-value="minor">Minor</div>
                            <div class="chord-type-btn" data-value="major6">6</div>
                            <div class="chord-type-btn" data-value="minor6">m6</div>
                            <div class="chord-type-btn active" data-value="dominant7">7</div>
                            <div class="chord-type-btn" data-value="major7">Maj7</div>
                            <div class="chord-type-btn" data-value="minor7">m7</div>
                            <div class="chord-type-btn" data-value="minor7b5">m7‚ô≠5</div>
                            <div class="chord-type-btn" data-value="dominant9">9</div>
                            <div class="chord-type-btn" data-value="major9">Maj9</div>
                            <div class="chord-type-btn" data-value="minor9">m9</div>
                            <div class="chord-type-btn" data-value="sus2">sus2</div>
                            <div class="chord-type-btn" data-value="sus4">sus4</div>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-label">
                            È°∫Â∫è
                            <span class="info">ÈÄâÊã©ÂíåÂº¶Èü≥Á¨¶ÁöÑÊºîÂ•èÈ°∫Â∫è</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn chord-order-btn active" data-value="ordered">È°∫Â∫è</div>
                            <div class="order-btn chord-order-btn" data-value="random">‰π±Â∫è</div>
                        </div>
                    </div>

                    <!-- Ëá™ÂÆö‰πâÂíåÂº¶ËøõË°åÊéß‰ª∂ -->
                    <div class="settings-row">
                        <div class="settings-label">
                            Ëá™ÂÆö‰πâÂíåÂº¶:
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="useCustomChords">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    
                    <div id="customChordsControls" style="display: none; margin-top: 10px;">
                        <style>
                            .custom-chord-add {
                                display: flex;
                                gap: 8px;
                                margin-bottom: 12px;
                            }
                            
                            .custom-chord-add select {
                                width: 120px;
                                padding: 8px;
                                background: #2c2c3c;
                                border: 1px solid #555;
                                border-radius: 8px;
                                color: #fff;
                            }
                            
                            .custom-chord-add button {
                                padding: 8px 12px;
                                background: linear-gradient(to right, #4fc3f7, #29b6f6);
                                border: none;
                                border-radius: 8px;
                                color: white;
                                cursor: pointer;
                            }
                            
                            .custom-chord-list {
                                background: rgba(30, 41, 59, 0.5);
                                padding: 12px;
                                border-radius: 8px;
                                margin-top: 8px;
                            }
                            
                            .custom-chord-actions {
                                display: flex;
                                gap: 8px;
                                margin-top: 12px;
                            }
                            
                            .custom-chord-actions {
                                display: flex;
                                gap: 8px;
                                margin-top: 12px;
                            }
                            
                            .custom-chord-actions button {
                                flex: 1;
                                padding: 8px;
                                background: #2c2c3c;
                                border: 1px solid #555;
                                border-radius: 6px;
                                color: #aaa;
                                cursor: pointer;
                                min-width: 40px;
                            }
                            
                            .custom-chord-actions button:hover {
                                background: rgba(58, 159, 196, 0.2);
                                color: #3a9fc4;
                                border-color: #3a9fc4;
                            }
                            
                            #customChordSequence {
                                display: flex;
                                flex-wrap: wrap;
                                gap: 6px;
                                margin-top: 8px;
                            }
                            
                            .chord-item {
                                display: flex;
                                justify-content: space-between;
                                padding: 6px 8px;
                                background: rgba(51, 65, 85, 0.7);
                                border-radius: 4px;
                                min-width: 60px;
                                max-width: 100px;
                                flex: 1 0 auto;
                            }
                            
                            .remove-chord {
                                background: transparent;
                                border: none;
                                color: #ff6b6b;
                                cursor: pointer;
                                font-weight: bold;
                            }
                            
                            .sequence-dialog {
                                position: fixed;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                background: rgba(40, 40, 50, 0.95);
                                padding: 20px;
                                border-radius: 12px;
                                z-index: 2000;
                                width: 80%;
                                max-width: 400px;
                                backdrop-filter: blur(10px);
                                border: 1px solid rgba(255,255,255,0.1);
                            }
                            
                            .sequence-item-dialog {
                                padding: 10px;
                                margin: 8px 0;
                                background: rgba(51, 65, 85, 0.7);
                                border-radius: 8px;
                                cursor: pointer;
                            }
                            
                            .sequence-item-dialog:hover {
                                background: rgba(58, 159, 196, 0.3);
                            }
                        </style>
                        <div class="custom-chord-add">
                            <select id="customChordRoot">
                                <option value="C">C</option>
                                <option value="C#">C#</option>
                                <option value="D">D</option>
                                <option value="D#">D#</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="F#">F#</option>
                                <option value="G">G</option>
                                <option value="G#">G#</option>
                                <option value="A">A</option>
                                <option value="A#">A#</option>
                                <option value="B">B</option>
                            </select>
                            <select id="customChordType">
                                <option value="major">Â§ß‰∏âÂíåÂº¶</option>
                                <option value="minor">Â∞è‰∏âÂíåÂº¶</option>
                                <option value="dominant7">Â±û‰∏ÉÂíåÂº¶</option>
                                <option value="major7">Â§ß‰∏ÉÂíåÂº¶</option>
                                <option value="minor7">Â∞è‰∏ÉÂíåÂº¶</option>
                                <option value="sus2">ÊåÇ‰∫åÂíåÂº¶</option>
                                <option value="sus4">ÊåÇÂõõÂíåÂº¶</option>
                                <option value="diminished">ÂáèÂíåÂº¶</option>
                                <option value="augmented">Â¢ûÂíåÂº¶</option>
                            </select>
                            <button id="addCustomChord">Ê∑ªÂä†ÂíåÂº¶</button>
                        </div>
                        
                        <div class="custom-chord-list">
                            <div class="settings-label">Ëá™ÂÆö‰πâÂíåÂº¶ËøõË°å:</div>
                            <div class="sequence-name-input" style="margin-bottom: 8px;">
                                <input type="text" id="sequenceName" placeholder="ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÂêçÔºàÂèØÈÄâÔºâ" style="width: 100%; height:25px;margin-top: 8px; padding: 4px; border: none; border-radius: 4px; background-color: rgba(255, 255, 255, 0.1); color: white;" />
                            </div>
                            <div id="customChordSequence"></div>
                            <div class="custom-chord-actions">
                                <button id="clearCustomChords">Ê∏ÖÁ©∫Ëá™ÂÆö‰πâÂíåÂº¶ËøõË°å</button>
                                <button id="saveCustomChords">‰øùÂ≠òÂíåÂº¶ËøõË°åÂà∞Êú¨Âú∞</button>
                                <button id="loadLocalChords">Âä†ËΩΩÊú¨Âú∞ÂíåÂº¶ËøõË°å</button>
                                <button id="loadSequence">Âä†ËΩΩÂ∫èÂàó</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ËÆæÁΩÆ -->
                <div class="settings-section device-settings" style="display:none;">
                    <div class="settings-section-title">
                        <i>üé§</i> Èü≥È¢ëËæìÂÖ•ËÆæÁΩÆ
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">
                            Èü≥È¢ëËæìÂÖ•ËÆæÂ§á
                            <span class="info">ÈÄâÊã©Âêâ‰ªñËøûÊé•ÁöÑÂ£∞Âç°ËÆæÂ§á</span>
                        </div>

                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <select id="audioInputDevice" style="width: 70%; padding: 8px; border-radius: 4px;"></select>
                        <button class="btn" id="refreshDevicesBtn" style="width: 25%; padding: 8px; font-size: 14px; margin-left: 10px;">Âà∑Êñ∞ËÆæÂ§áÂàóË°®</button>
                    </div>

                    <div class="device-info" id="deviceInfo">
                        Ê£ÄÊµãÂà∞ËÆæÂ§áÂêéÔºåËØ∑ÈÄâÊã©ÊÇ®ÁöÑUSBÈü≥È¢ëÊé•Âè£
                    </div>
                    <div class="settings-row" style="margin-top: 12px;">
                        <div class="settings-label">
                            ËæìÂÖ•Â¢ûÁõä
                            <span class="info">Ë∞ÉËäÇËæìÂÖ•Èü≥ÈáèÂ§ßÂ∞è</span>
                        </div>
                        <div class="gain-control">
                            <input type="range" id="inputGain" min="0" max="200" value="100">
                            <span class="gain-value" id="inputGainValue">100%</span>
                        </div>
                    </div>
                    
                    <div class="settings-section-title" style="margin-top: 20px;">
                        <i>üéØ</i> ËäÇÊãçÂô®ËÆæÁΩÆ
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="switch-label">ÂêØÁî®ËäÇÊãçÂô®</span>
                            <label class="switch">
                                <input type="checkbox" id="metronomeToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; width: 60%; margin-left: auto;">
                            <span style="white-space: nowrap; font-size: 14px;">ÈÄüÂ∫¶:</span>
                            <input type="range" id="metronomeTempo" min="20" max="120" step="1" value="40" style="width: 65%; margin-right: 3px;">
                            <span id="metronomeTempoValue" style="min-width: 25px; text-align: right; font-size: 14px;">40</span>
                        </div>
                    </div>
                </div>
                
                <!-- Èü≥Èò∂ËÆæÁΩÆ - Âè™Âú®Èü≥Èò∂ÁªÉ‰π†Ê†áÁ≠æÈ°µÊòæÁ§∫ -->
                <div class="settings-section scale-settings" style="display: none;">
                    <div class="settings-section-title">
                        <i>üéµ</i> Èü≥Èò∂ËÆæÁΩÆ
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-label">
                            Ë∞É
                            <span class="info">ÈÄâÊã©Ë∞É</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="rootNote">
                                <option value="C">C</option>
                                <option value="C‚ôØ">C#/Db</option>
                                <option value="D">D</option>
                                <option value="D‚ôØ">D#/Eb</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="F‚ôØ">F#/Gb</option>
                                <option value="G">G</option>
                                <option value="G‚ôØ">G#/Ab</option>
                                <option value="A">A</option>
                                <option value="A‚ôØ">A#/Bb</option>
                                <option value="B">B</option>
                                <option value="random" selected>ÈöèÊú∫</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-label">
                            Ë∞ÉÂºè
                            <span class="info">ÈÄâÊã©Èü≥Èò∂Ë∞ÉÂºè</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="scaleType">
                                <option value="major">Major</option>
                                <option value="minor">Minor</option>
                                <option value="majorPentatonic">Major Pentatonic</option>
                                <option value="minorPentatonic">Minor Pentatonic</option>
                                <option value="blues">Blues</option>
                                <option value="dorian">Dorian</option>
                                <option value="mixolydian">Mixolydian</option>
                                <option value="random" selected>ÈöèÊú∫Ë∞ÉÂºè</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-label">
                            È°∫Â∫è
                            <span class="info">ÈÄâÊã©Èü≥Èò∂È°∫Â∫è</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn scale-order-btn active" data-value="ordered">È°∫Â∫è</div>
                            <div class="order-btn scale-order-btn" data-value="reverse">ÂÄíÂ∫è</div>
                            <div class="order-btn scale-order-btn" data-value="random">‰π±Â∫è</div>
                        </div>
                    </div>
                </div>
                
                <!-- ÂíåÂº¶ËÆæÁΩÆ -->
                <div class="settings-section chord-settings" style="display: none;">
                    <div class="settings-section-title">
                        <i>üé∂</i> ÂíåÂº¶ËÆæÁΩÆ
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-label">
                            Ê†πÈü≥
                            <span class="info">ÈÄâÊã©ÂíåÂº¶ÁöÑÊ†πÈü≥</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="chordRootNote">
                                <option value="C">C</option>
                                <option value="C‚ôØ">C#/Db</option>
                                <option value="D">D</option>
                                <option value="D‚ôØ">D#/Eb</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="F‚ôØ">F#/Gb</option>
                                <option value="G">G</option>
                                <option value="G‚ôØ">G#/Ab</option>
                                <option value="A">A</option>
                                <option value="A‚ôØ">A#/Bb</option>
                                <option value="B">B</option>
                                <option value="random" selected>ÈöèÊú∫Ê†πÈü≥</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-label">
                            ÂíåÂº¶Á±ªÂûã
                            <span class="info">ÈÄâÊã©Ë¶ÅÁªÉ‰π†ÁöÑÂíåÂº¶Á±ªÂûã</span>
                        </div>
                        <div class="chord-type-container">
                            <div class="chord-type-btn active" data-value="major">Major</div>
                            <div class="chord-type-btn active" data-value="minor">Minor</div>
                            <div class="chord-type-btn" data-value="major6">6</div>
                            <div class="chord-type-btn" data-value="minor6">m6</div>
                            <div class="chord-type-btn active" data-value="dominant7">7</div>
                            <div class="chord-type-btn" data-value="major7">Maj7</div>
                            <div class="chord-type-btn" data-value="minor7">m7</div>
                            <div class="chord-type-btn" data-value="minor7b5">m7‚ô≠5</div>
                            <div class="chord-type-btn" data-value="dominant9">9</div>
                            <div class="chord-type-btn" data-value="major9">Maj9</div>
                            <div class="chord-type-btn" data-value="minor9">m9</div>
                            <div class="chord-type-btn" data-value="sus2">sus2</div>
                            <div class="chord-type-btn" data-value="sus4">sus4</div>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-label">
                            È°∫Â∫è
                            <span class="info">ÈÄâÊã©ÂíåÂº¶Èü≥Á¨¶ÁöÑÊºîÂ•èÈ°∫Â∫è</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn chord-order-btn active" data-value="ordered">È°∫Â∫è</div>
                            <div class="order-btn chord-order-btn" data-value="random">‰π±Â∫è</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn" id="startBtn">ÂºÄÂßãÁªÉ‰π†</button>
        </div>
    </div>
    
    <!-- ÁªÉ‰π†Ê®°ÂºèÂÖ®Â±èÈ°µÈù¢ -->
    <div id="practiceScreen">
        <div class="exercise-container">
            <div class="scale-info">
                <div class="target-interval" id="targetInterval">C Major</div>
            </div>
            
            <div class="sequence-display">
                <div class="sequence-title">ËØ∑‰æùÊ¨°ÂºπÂ•è:</div>
                <div class="sequence-items" id="sequenceDisplay"></div>
            </div>
        </div>
        
        <div class="next-exercise">
            <div class="next-content-wrapper">
                <div class="next-label">‰∏ã‰∏Ä‰∏™:</div>
                <div class="next-content" id="nextExercise">-</div>
            </div>
        </div>
    </div>

    <script>
        // PitchFinderÂ∫ìÂÜÖËÅî‰ª£Á†Å - Áõ¥Êé•ÂµåÂÖ•Â¢ûÂº∫ÁâàYINÁÆóÊ≥ïÂÆûÁé∞
        (function(global) {
            // PitchFinder‰∏ªÂØπË±°
            var Pitchfinder = {};
            
            // Â¢ûÂº∫ÁâàYINÁÆóÊ≥ïÂÆûÁé∞
            Pitchfinder.YIN = function(config) {
                config = config || {};
                var threshold = config.threshold || 0.15;
                var probabilityCliff = config.probabilityCliff || 0.1;
                
                return function(float32AudioBuffer) {
                    const buffer = float32AudioBuffer;
                    const N = buffer.length;
                    const halfN = Math.floor(N / 2);
                    const d = new Float32Array(halfN);
                    
                    // Ê≠•È™§1: Â∑ÆÂàÜÂáΩÊï∞
                    for (let tau = 0; tau < halfN; tau++) {
                        let sum = 0;
                        for (let i = 0; i < halfN; i++) {
                            const diff = buffer[i] - buffer[i + tau];
                            sum += diff * diff;
                        }
                        d[tau] = sum;
                    }
                    
                    // Ê≠•È™§2: Á¥ØÁßØÂπ≥ÂùáÂΩí‰∏ÄÂåñ
                    let runningSum = 0;
                    d[0] = 1;
                    for (let tau = 1; tau < halfN; tau++) {
                        runningSum += d[tau];
                        d[tau] = d[tau] * tau / runningSum;
                    }
                    
                    // Ê≠•È™§3: ÈòàÂÄºÊ£ÄÊµã
                    let tauEstimate = -1;
                    for (let tau = 1; tau < halfN; tau++) {
                        if (d[tau] < threshold) {
                            while (tau + 1 < halfN && d[tau + 1] < d[tau]) tau++;
                            tauEstimate = tau;
                            break;
                        }
                    }
                    
                    if (tauEstimate === -1) return null;
                    
                    // Ê≠•È™§4: ÊäõÁâ©Á∫øÊèíÂÄºÊèêÈ´òÁ≤æÂ∫¶
                    let betterTau = tauEstimate;
                    if (tauEstimate > 0 && tauEstimate < halfN - 1) {
                        const s0 = d[tauEstimate - 1], s1 = d[tauEstimate], s2 = d[tauEstimate + 1];
                        const denom = (s0 + s2 - 2 * s1);
                        if (denom !== 0) {
                            const delta = (s0 - s2) / (2 * denom);
                            betterTau = tauEstimate + delta;
                        }
                    }
                    
                    const frequency = 48000 / betterTau;
                    const probability = Math.max(0, Math.min(1, 1 - d[tauEstimate]));
                    
                    if (probability < probabilityCliff) return null;
                    
                    return { frequency, probability };
                };
            };
            
            // Â∞ÜPitchFinderÊö¥Èú≤ÁªôÂÖ®Â±Ä
            global.Pitchfinder = Pitchfinder;
        })(window);

        document.addEventListener('DOMContentLoaded', function() {
            // Âêâ‰ªñÊ†áÂáÜË∞ÉÂº¶
            const standardTuning = ['E', 'B', 'G', 'D', 'A', 'E'];
            
            // ÊâÄÊúâÂèØËÉΩÁöÑÈü≥Á∫ß
            const intervals = ['1', '‚ô≠2', '2', '‚ô≠3', '3', '4', '‚ôØ4', '5', '‚ô≠6', '6', '‚ô≠7', '7'];
            
            // Èü≥Á∫ßÂà∞ÂçäÈü≥Ë∑ùÁ¶ªÁöÑÊò†Â∞Ñ
            const intervalToSemitones = {
                '1': 0,
                '‚ô≠2': 1,
                '2': 2,
                '‚ô≠3': 3,
                '3': 4,
                '4': 5,
                '‚ôØ4': 6,
                '‚ô≠5': 6,
                '5': 7,
                '‚ô≠6': 8,
                '6': 9,
                '‚ô≠7': 10,
                '7': 11
            };
            
            // Èü≥ÂêçÂà∞ÂçäÈü≥Êï∞ÁöÑÊò†Â∞ÑÔºàC = 0Ôºâ
            const noteToSemitones = {
                'C': 0, 'C‚ôØ': 1, 'D‚ô≠': 1, 'D': 2, 'D‚ôØ': 3, 'E‚ô≠': 3, 'E': 4, 
                'F': 5, 'F‚ôØ': 6, 'G‚ô≠': 6, 'G': 7, 'G‚ôØ': 8, 'A‚ô≠': 8, 
                'A': 9, 'A‚ôØ': 10, 'B‚ô≠': 10, 'B': 11
            };
            
            // Èü≥Èò∂Á±ªÂûãÂÆö‰πâ
            const scaleTypes = {
                'major': { name: 'Major', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                'minor': { name: 'Minor', intervals: ['1', '2', '‚ô≠3', '4', '5', '‚ô≠6', '‚ô≠7'] },
                'majorPentatonic': { name: 'Major Pentatonic', intervals: ['1', '2', '3', '5', '6'] },
                'minorPentatonic': { name: 'Minor Pentatonic', intervals: ['1', '‚ô≠3', '4', '5', '‚ô≠7'] },
                'blues': { name: 'Blues', intervals: ['1', '‚ô≠3', '4', '‚ôØ4', '5', '‚ô≠7'] },
                'dorian': { name: 'Dorian', intervals: ['1', '2', '‚ô≠3', '4', '5', '6', '‚ô≠7'] },
                'mixolydian': { name: 'Mixolydian', intervals: ['1', '2', '3', '4', '5', '6', '‚ô≠7'] }
            };
            
            // ÂíåÂº¶Á±ªÂûãÂÆö‰πâ
            const chordTypes = {
                'major': { name: 'Â§ß‰∏âÂíåÂº¶', intervals: ['1', '3', '5'] },
                'minor': { name: 'Â∞è‰∏âÂíåÂº¶', intervals: ['1', '‚ô≠3', '5'] },
                'major6': { name: 'Â§ßÂÖ≠ÂíåÂº¶', intervals: ['1', '3', '5', '6'] },
                'minor6': { name: 'Â∞èÂÖ≠ÂíåÂº¶', intervals: ['1', '‚ô≠3', '5', '6'] },
                'dominant7': { name: 'Â±û‰∏ÉÂíåÂº¶', intervals: ['1', '3', '5', '‚ô≠7'] },
                'major7': { name: 'Â§ß‰∏ÉÂíåÂº¶', intervals: ['1', '3', '5', '7'] },
                'minor7': { name: 'Â∞è‰∏ÉÂíåÂº¶', intervals: ['1', '‚ô≠3', '5', '‚ô≠7'] },
                'minor7b5': { name: 'ÂçäÂáè‰∏ÉÂíåÂº¶', intervals: ['1', '‚ô≠3', '‚ô≠5', '‚ô≠7'] },
                'dominant9': { name: 'Â±û‰πùÂíåÂº¶', intervals: ['1', '3', '5', '‚ô≠7', '9'] },
                'major9': { name: 'Â§ß‰πùÂíåÂº¶', intervals: ['1', '3', '5', '7', '9'] },
                'minor9': { name: 'Â∞è‰πùÂíåÂº¶', intervals: ['1', '‚ô≠3', '5', '‚ô≠7', '9'] },
                'sus2': { name: 'ÊåÇ‰∫åÂíåÂº¶', intervals: ['1', '2', '5'] },
                'sus4': { name: 'ÊåÇÂõõÂíåÂº¶', intervals: ['1', '4', '5'] }
            };
            
            // ÂÖÉÁ¥†ÂºïÁî®
            const mainScreen = document.getElementById('mainScreen');
            const practiceScreen = document.getElementById('practiceScreen');
            const targetIntervalEl = document.getElementById('targetInterval');
            const sequenceDisplayEl = document.getElementById('sequenceDisplay');
            const nextExerciseEl = document.getElementById('nextExercise');
            const startBtn = document.getElementById('startBtn');
            const refreshDevicesBtn = document.getElementById('refreshDevicesBtn');
            const rootNoteEl = document.getElementById('rootNote');
            const scaleTypeEl = document.getElementById('scaleType');
            const chordRootNoteEl = document.getElementById('chordRootNote');
            const audioInputDeviceEl = document.getElementById('audioInputDevice');
            const inputGainEl = document.getElementById('inputGain');
            const inputGainValueEl = document.getElementById('inputGainValue');
            const deviceInfoEl = document.getElementById('deviceInfo');
            const statusIndicator = document.getElementById('statusIndicator');
            const shortcutHint = document.getElementById('shortcutHint');
            const metronomeToggleEl = document.getElementById('metronomeToggle');
            const metronomeTempoEl = document.getElementById('metronomeTempo');
            const metronomeTempoValueEl = document.getElementById('metronomeTempoValue');
            const deviceSettings = document.querySelector('.device-settings');
            
            // ÈÄâÈ°πÂç°ÂÖÉÁ¥†
            const settingsTabs = document.querySelectorAll('.settings-tab');
            const scaleSettings = document.querySelector('.scale-settings');
            const chordSettings = document.querySelector('.chord-settings');
            
            // ÂíåÂº¶Á±ªÂûãÊåâÈíÆ
            const chordTypeBtns = document.querySelectorAll('.chord-type-btn');
            
            // Èü≥È¢ëËÆæÂ§áÁÆ°ÁêÜ
            let audioDevices = [];
            let selectedDeviceId = 'default';
            let inputGain = 1.0;
            let gainNode = null;
            
            // Â±èÂπïÂî§ÈÜíÈîÅÂèòÈáè
            let wakeLock = null;
            
            // Èü≥È¢ëÂàÜÊûêÂèòÈáè
            let audioContext = null;
            let analyser = null;
            let microphone = null;
            let javascriptNode = null;
            let isRecording = false;
            let mediaStream = null;
            
            // ÁªÉ‰π†Áä∂ÊÄÅ
            let state = {
                score: 0,
                correctCount: 0,
                totalCount: 0,
                accuracy: 0,
                rootNote: '',
                scaleType: '',
                chordType: '',
                currentIntervals: [],
                currentSequence: [],
                currentStep: 0,
                correctPositions: [],
				isCoolingDown: false,
				cooldownTimeout: null,
				cooldownDuration: 800, // ÂÜ∑Âç¥ÊúüÊåÅÁª≠Êó∂Èó¥(ÊØ´Áßí)
                isAnswered: false,
                timeoutId: null,
                maxFret: 12,
                previousMaxFret: 12,
                isRecording: false,
                sensitivity: 0.5,
                confidenceThreshold: 0.5,
                noiseLevel: 0.001,
                minVolume: 0.001,
                microphoneInitialized: false,
                pitchBuffer: [],
                bufferSize: 3,
                zeroCrossingThreshold: 0.1,
                harmonicWeights: [1.0, 0.8, 0.6],
                nextExerciseInfo: '',
                nextExerciseIntervals: [],
                metronomeEnabled: document.getElementById('metronomeToggle').checked,
                metronomeTempo: parseInt(document.getElementById('metronomeTempo').value),
                metronomeInterval: null
            };
            
            // ËØ∑Ê±ÇÂ±èÂπïÂî§ÈÜíÈîÅ
            async function requestWakeLock() {
                try {
                    if ('wakeLock' in navigator) {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('Â±èÂπïÂî§ÈÜíÈîÅÂ∑≤ÊøÄÊ¥ª');
                        
                        wakeLock.addEventListener('release', () => {
                            console.log('Â±èÂπïÂî§ÈÜíÈîÅÂ∑≤ÈáäÊîæ');
                        });
                    }
                } catch (err) {
                    console.error(`Êó†Ê≥ïËé∑ÂèñÂ±èÂπïÂî§ÈÜíÈîÅ: ${err.message}`);
                }
            }
            
            // ÈáäÊîæÂ±èÂπïÂî§ÈÜíÈîÅ
            function releaseWakeLock() {
                if (wakeLock !== null) {
                    wakeLock.release();
                    wakeLock = null;
                }
            }
            
            // Ëé∑ÂèñÈü≥È¢ëËÆæÂ§áÂàóË°®
            async function getAudioDevices() {
                try {
                    // ËØ∑Ê±ÇÊùÉÈôê‰ª•Ëé∑ÂèñËÆæÂ§áÊ†áÁ≠æ
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    audioDevices = devices.filter(device => device.kind === 'audioinput');
                    
                    updateAudioDeviceSelector();
                    checkForAudioInterfaces();
                } catch (error) {
                    console.error('Ëé∑ÂèñÈü≥È¢ëËÆæÂ§áÂ§±Ë¥•:', error);
                    deviceInfoEl.textContent = "Êó†Ê≥ïËé∑ÂèñÈü≥È¢ëËÆæÂ§áÂàóË°®ÔºåËØ∑Á°Æ‰øùÂ∑≤Êéà‰∫àÈ∫¶ÂÖãÈ£éÊùÉÈôê";
                }
            }
            
            // Êõ¥Êñ∞ËÆæÂ§áÈÄâÊã©Âô®
            function updateAudioDeviceSelector() {
                const selector = document.getElementById('audioInputDevice');
                selector.innerHTML = '<option value="default">ÈªòËÆ§ËÆæÂ§á</option>';
                
                audioDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `Èü≥È¢ëËÆæÂ§á ${selector.options.length}`;
                    selector.appendChild(option);
                });
                
                if (audioDevices.length > 0) {
                    deviceInfoEl.textContent = `Ê£ÄÊµãÂà∞ ${audioDevices.length} ‰∏™Èü≥È¢ëËæìÂÖ•ËÆæÂ§á`;
                } else {
                    deviceInfoEl.textContent = "Êú™Ê£ÄÊµãÂà∞Èü≥È¢ëËæìÂÖ•ËÆæÂ§á";
                }
            }
            
            // Ê£ÄÊµãÊòØÂê¶Êúâ‰∏ì‰∏öÈü≥È¢ëËÆæÂ§á
            function checkForAudioInterfaces() {
                const hasProfessionalDevices = audioDevices.some(device => 
                    device.label.toLowerCase().includes('interface') ||
                    device.label.toLowerCase().includes('usb') ||
                    device.label.toLowerCase().includes('focusrite') ||
                    device.label.toLowerCase().includes('scarlett') ||
                    device.label.toLowerCase().includes('presonus') ||
                    device.label.toLowerCase().includes('behringer') ||
                    device.label.toLowerCase().includes('steinberg') ||
                    device.label.toLowerCase().includes('zoom') ||
                    device.label.toLowerCase().includes('boss') ||
                    device.label.toLowerCase().includes('line6')
                );
                
                if (hasProfessionalDevices) {
                    showAudioInterfaceTip();
                }
            }
            
            function showAudioInterfaceTip() {
                const tip = document.createElement('div');
                tip.style.cssText = `
                    position: fixed;
                    top: 70px;
                    right: 20px;
                    background: rgba(56, 189, 248, 0.9);
                    color: white;
                    padding: 10px 15px;
                    border-radius: 8px;
                    font-size: 12px;
                    z-index: 1002;
                    max-width: 250px;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255,255,255,0.2);
                `;
                tip.innerHTML = `
                    <strong><span class="usb-indicator"></span> USBÂ£∞Âç°Â∑≤Ê£ÄÊµã</strong><br>
                    Âª∫ËÆÆÈÄâÊã©ÊÇ®ÁöÑÈü≥È¢ëÊé•Âè£ËÆæÂ§á‰ª•Ëé∑ÂæóÊúÄ‰Ω≥ÊïàÊûú
                `;
                document.body.appendChild(tip);
                
                setTimeout(() => {
                    if (tip.parentNode) {
                        tip.parentNode.removeChild(tip);
                    }
                }, 5000);
            }
            
            // ‰ΩøÁî®ÊåáÂÆöËÆæÂ§áÈáçÊñ∞ÂêØÂä®Èü≥È¢ë
            async function restartAudioWithNewDevice() {
                stopRecording();
                await new Promise(resolve => setTimeout(resolve, 100));
                startRecording();
            }
            
            // ÂêØÂä®È∫¶ÂÖãÈ£éÂΩïÈü≥ - ÊîØÊåÅËÆæÂ§áÈÄâÊã©
            async function startRecording() {
                if (isRecording) return;
                
                try {
                    const constraints = {
                        audio: {
                            deviceId: selectedDeviceId !== 'default' ? 
                                     { exact: selectedDeviceId } : undefined,
                            sampleRate: 48000,
                            channelCount: 1,
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false,
                            latency: 0.01
                        }
                    };
                    
                    mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)({
                            sampleRate: 48000,
                            latencyHint: 'interactive'
                        });
                    }
                    
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 4096;
                    
                    // ÂàõÂª∫Â¢ûÁõäËäÇÁÇπÁî®‰∫éÈü≥ÈáèÊéßÂà∂
                    gainNode = audioContext.createGain();
                    gainNode.gain.value = inputGain;
                    
                    javascriptNode = audioContext.createScriptProcessor(4096, 1, 1);
                    javascriptNode.onaudioprocess = processAudio;
                    
                    microphone = audioContext.createMediaStreamSource(mediaStream);
                    
                    // ËøûÊé•Èü≥È¢ëËäÇÁÇπÔºöÈ∫¶ÂÖãÈ£é -> Â¢ûÁõä -> ÂàÜÊûêÂô® -> Â§ÑÁêÜËäÇÁÇπ -> ËæìÂá∫
                    microphone.connect(gainNode);
                    gainNode.connect(analyser);
                    analyser.connect(javascriptNode);
                    javascriptNode.connect(audioContext.destination);
                    
                    isRecording = true;
                    state.microphoneInitialized = true;
                    updateStatusIndicator('ÂΩïÈü≥‰∏≠...', 'recording');
                    
                    console.log('Èü≥È¢ëËæìÂÖ•Â∑≤ÂêØÂä®ÔºåËÆæÂ§á:', 
                               selectedDeviceId === 'default' ? 'ÈªòËÆ§ËÆæÂ§á' : 
                               audioDevices.find(d => d.deviceId === selectedDeviceId)?.label);
                    
                } catch (e) {
                    console.error('Èü≥È¢ëÂàùÂßãÂåñÂ§±Ë¥•:', e);
                    updateStatusIndicator('Èü≥È¢ëÂàùÂßãÂåñÂ§±Ë¥•', 'error');
                    
                    // Â∞ùËØï‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆ
                    if (e.name === 'OverconstrainedError') {
                        console.log('Â∞ùËØï‰ΩøÁî®ÂÖºÂÆπÁöÑÈü≥È¢ëËÆæÁΩÆ...');
                        try {
                            mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            initializeBasicAudio();
                        } catch (fallbackError) {
                            console.error('Â§áÁî®Èü≥È¢ëÂàùÂßãÂåñ‰πüÂ§±Ë¥•:', fallbackError);
                        }
                    }
                }
            }
            
            // ÁÆÄÂåñÁöÑÈü≥È¢ëÂàùÂßãÂåñÔºàÂÖºÂÆπÊ®°ÂºèÔºâ
            function initializeBasicAudio() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 4096;
                javascriptNode = audioContext.createScriptProcessor(4096, 1, 1);
                javascriptNode.onaudioprocess = processAudio;
                
                microphone = audioContext.createMediaStreamSource(mediaStream);
                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);
                
                isRecording = true;
                state.microphoneInitialized = true;
                updateStatusIndicator('ÂΩïÈü≥‰∏≠(ÂÖºÂÆπÊ®°Âºè)', 'recording');
            }
            
            // ÂÅúÊ≠¢È∫¶ÂÖãÈ£éÂΩïÈü≥
            function stopRecording() {
                if (!isRecording) return;
                
                if (javascriptNode) {
                    javascriptNode.disconnect();
                }
                if (analyser) {
                    analyser.disconnect();
                }
                if (microphone) {
                    microphone.disconnect();
                }
                if (gainNode) {
                    gainNode.disconnect();
                }
                
                isRecording = false;
            }
            
            // ÂÆåÂÖ®ÂÖ≥Èó≠È∫¶ÂÖãÈ£éÔºàÈÄÄÂá∫Â∫îÁî®Êó∂‰ΩøÁî®Ôºâ
            function closeMicrophone() {
                stopRecording();
                
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
                
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
                
                state.microphoneInitialized = false;
            }
            
            // ËæÖÂä©ÂáΩÊï∞ÂíåÁ±ª
            class MedianFilter {
                constructor(size) {
                    this.size = Math.max(1, size | 0);
                    this.buffer = [];
                }
                push(val) {
                    this.buffer.push(val == null ? null : val);
                    if (this.buffer.length > this.size) this.buffer.shift();
                    const arr = this.buffer.filter(v => v != null);
                    if (arr.length === 0) return null;
                    const sorted = arr.slice().sort((a, b) => a - b);
                    const mid = Math.floor(sorted.length / 2);
                    if (sorted.length % 2 === 1) return sorted[mid];
                    return (sorted[mid - 1] + sorted[mid]) / 2;
                }
            }

            function ema(prev, current, alpha) {
                if (prev == null) return current;
                return alpha * current + (1 - alpha) * prev;
            }

            function applyHannWindow(buf) {
                const N = buf.length;
                for (let i = 0; i < N; i++) {
                    const w = 0.5 * (1 - Math.cos((2 * Math.PI * i) / (N - 1)));
                    buf[i] *= w;
                }
            }

            function rms(buf) {
                let sum = 0;
                for (let i = 0; i < buf.length; i++) sum += buf[i] * buf[i];
                return Math.sqrt(sum / buf.length);
            }

            function downsampleBuffer(buffer, originalRate, targetRate) {
                if (targetRate >= originalRate) return buffer.slice(0);
                const ratio = originalRate / targetRate;
                const newLength = Math.floor(buffer.length / ratio);
                const out = new Float32Array(newLength);
                for (let i = 0; i < newLength; i++) {
                    const start = Math.floor(i * ratio);
                    const end = Math.floor((i + 1) * ratio);
                    let sum = 0;
                    for (let j = start; j < end && j < buffer.length; j++) sum += buffer[j];
                    out[i] = sum / Math.max(1, end - start);
                }
                return out;
            }

            function YINDetectorFactory(sampleRate, config) {
                config = config || {};
                const threshold = config.threshold || 0.15;
                const probabilityCliff = config.probabilityCliff || 0.1;
                return function(float32AudioBuffer) {
                    const buffer = float32AudioBuffer;
                    const N = buffer.length;
                    const halfN = Math.floor(N / 2);
                    const d = new Float32Array(halfN);
                    for (let tau = 0; tau < halfN; tau++) {
                        let sum = 0;
                        for (let i = 0; i < halfN; i++) {
                            const diff = buffer[i] - buffer[i + tau];
                            sum += diff * diff;
                        }
                        d[tau] = sum;
                    }
                    let runningSum = 0;
                    d[0] = 1;
                    for (let tau = 1; tau < halfN; tau++) {
                        runningSum += d[tau];
                        d[tau] = d[tau] * tau / runningSum;
                    }
                    let tauEstimate = -1;
                    for (let tau = 1; tau < halfN; tau++) {
                        if (d[tau] < threshold) {
                            while (tau + 1 < halfN && d[tau + 1] < d[tau]) tau++;
                            tauEstimate = tau;
                            break;
                        }
                    }
                    if (tauEstimate === -1) return null;
                    let betterTau = tauEstimate;
                    if (tauEstimate > 0 && tauEstimate < halfN - 1) {
                        const s0 = d[tauEstimate - 1], s1 = d[tauEstimate], s2 = d[tauEstimate + 1];
                        const denom = (s0 + s2 - 2 * s1);
                        if (denom !== 0) {
                            const delta = (s0 - s2) / (2 * denom);
                            betterTau = tauEstimate + delta;
                        }
                    }
                    const frequency = sampleRate / betterTau;
                    const probability = Math.max(0, Math.min(1, 1 - d[tauEstimate]));
                    if (probability < probabilityCliff) return null;
                    return { frequency, probability };
                };
            }

            // Â¢ûÂº∫ÁâàÈü≥È´òÊ£ÄÊµãÂô®
            class EnhancedPitchDetector {
                constructor() {
                    this.bufferSize = 8; // Â¢ûÂä†ÁºìÂÜ≤Âå∫Â§ßÂ∞èÔºåÊèêÈ´òÁ®≥ÂÆöÊÄß
                    this.pitchBuffer = [];
                    this.lastStablePitch = null;
                    this.stabilityCounter = 0;
                    this.frequencyBias = { // ÈíàÂØπÁâπÂÆöÈ¢ëÁéáËåÉÂõ¥ÁöÑÂÅèÂ∑ÆÊ†°Ê≠£
                        'F': 1.02,  // ËΩªÂæÆÊèêÂçáFÂå∫ÂüüÁöÑÊ£ÄÊµãÂÄº
                        'F‚ôØ': 0.98  // ËΩªÂæÆÈôç‰ΩéF‚ôØÂå∫ÂüüÁöÑÊ£ÄÊµãÂÄº
                    };
                }

                detect(float32AudioBuffer, sampleRate) {
                    // ‰ΩøÁî®YINÁÆóÊ≥ï‰Ωú‰∏∫Âü∫Á°ÄÔºå‰ΩÜÈôç‰ΩéÈòàÂÄºÊèêÈ´òÁÅµÊïèÂ∫¶
                    const yinPitch = Pitchfinder.YIN({threshold: 0.08})(float32AudioBuffer);
                    
                    // ‰ΩøÁî®Â¢ûÂº∫ÁöÑËá™Áõ∏ÂÖ≥Ê£ÄÊµã
                    const autocorrPitch = this.autocorrelationDetect(float32AudioBuffer, sampleRate);
                    
                    // ÁªìÂêà‰∏§ÁßçÁÆóÊ≥ïÁªìÊûúÔºåÂπ∂Â∫îÁî®È¢ëÁéáÂÅèÂ∑ÆÊ†°Ê≠£
                    let finalPitch = this.combineResults(yinPitch, autocorrPitch, sampleRate);
                    
                    // Â∫îÁî®Êõ¥‰∏•Ê†ºÁöÑÊª§Ê≥¢ÂíåÁºìÂÜ≤
                    finalPitch = this.applyFilter(finalPitch);
                    
                    // Â∫îÁî®È¢ëÁéáÂÅèÂ∑ÆÊ†°Ê≠£
                    finalPitch = this.applyFrequencyBias(finalPitch);
                    
                    return finalPitch;
                }

                autocorrelationDetect(buffer, sampleRate) {
                    // Â¢ûÂº∫ÁâàËá™Áõ∏ÂÖ≥ÁÆóÊ≥ïÔºåÁâπÂà´‰ºòÂåñ‰∏≠È¢ëÂå∫ÂüüÊ£ÄÊµã
                    const maxLag = Math.floor(sampleRate / 65);
                    const minLag = Math.floor(sampleRate / 1000);
                    
                    let bestLag = 0;
                    let bestCorrelation = -1;
                    
                    // ‰ΩøÁî®Âä†ÊùÉÁ™óÂè£Â¢ûÂº∫FÂíåF#Âå∫ÂüüÁöÑÊ£ÄÊµã
                    const fFreq = 349.23;
                    const fSharpFreq = 369.99;
                    const fLag = Math.floor(sampleRate / fFreq);
                    const fSharpLag = Math.floor(sampleRate / fSharpFreq);
                    
                    for (let lag = minLag; lag <= maxLag; lag++) {
                        let correlation = 0;
                        
                        for (let i = 0; i < buffer.length - lag; i++) {
                            correlation += buffer[i] * buffer[i + lag];
                        }
                        
                        correlation /= (buffer.length - lag);
                        
                        // Â∫îÁî®Ê±âÂÆÅÁ™óÂáèÂ∞ëËæπÁïåÊïàÂ∫î
                        const window = 0.5 * (1 - Math.cos(2 * Math.PI * lag / maxLag));
                        correlation *= window;
                        
                        // ÂØπFÂíåF#Âå∫ÂüüÂ∫îÁî®È¢ùÂ§ñÊùÉÈáç
                        if (Math.abs(lag - fLag) < 10 || Math.abs(lag - fSharpLag) < 10) {
                            correlation *= 1.2; // Â¢ûÂº∫Ëøô‰∫õÂå∫ÂüüÁöÑÁõ∏ÂÖ≥ÊÄß
                        }
                        
                        if (correlation > bestCorrelation) {
                            bestCorrelation = correlation;
                            bestLag = lag;
                        }
                    }
                    
                    return bestLag > 0 ? sampleRate / bestLag : null;
                }

                combineResults(yinPitch, autocorrPitch, sampleRate) {
                    if (!yinPitch || yinPitch <= 0) return autocorrPitch;
                    if (!autocorrPitch || autocorrPitch <= 0) return yinPitch;
                    
                    const ratio = yinPitch / autocorrPitch;
                    
                    // Êõ¥‰∏•Ê†ºÁöÑ‰∏ÄËá¥ÊÄßÊ£ÄÊü•
                    if (ratio > 0.9 && ratio < 1.1) {
                        // Â¶ÇÊûú‰∏§ÁßçÁÆóÊ≥ïÁªìÊûúÊé•ËøëÔºåÂèñÂä†ÊùÉÂπ≥Âùá
                        return (yinPitch * 0.6 + autocorrPitch * 0.4);
                    }
                    
                    // Âê¶ÂàôÈÄâÊã©ÁΩÆ‰ø°Â∫¶Êõ¥È´òÁöÑÁªìÊûú
                    const yinConfidence = this.calculateConfidence(yinPitch, sampleRate);
                    const autocorrConfidence = this.calculateConfidence(autocorrPitch, sampleRate);
                    
                    return yinConfidence > autocorrConfidence ? yinPitch : autocorrPitch;
                }

                applyFilter(pitch) {
                    if (!pitch || pitch <= 0) return null;
                    
                    this.pitchBuffer.push(pitch);
                    if (this.pitchBuffer.length > this.bufferSize) {
                        this.pitchBuffer.shift();
                    }
                    
                    // ‰ΩøÁî®‰∏≠‰ΩçÊï∞Êª§Ê≥¢ËÄå‰∏çÊòØÂπ≥ÂùáÂÄºÔºåÊõ¥ËÉΩÊäµÊäóÂºÇÂ∏∏ÂÄº
                    const sorted = [...this.pitchBuffer].sort((a, b) => a - b);
                    const medianPitch = sorted[Math.floor(sorted.length / 2)];
                    
                    // Â¢ûÂº∫Á®≥ÂÆöÊÄßÊ£ÄÊµã
                    if (this.lastStablePitch) {
                        const ratio = medianPitch / this.lastStablePitch;
                        if (ratio > 0.97 && ratio < 1.03) { // Êõ¥‰∏•Ê†ºÁöÑÁ®≥ÂÆöÊÄßÊ†áÂáÜ
                            this.stabilityCounter++;
                        } else {
                            this.stabilityCounter = 0;
                        }
                    }
                    
                    if (this.stabilityCounter >= 4) { // ÈúÄË¶ÅÊõ¥Â§öÁöÑËøûÁª≠Á®≥ÂÆöÊ†∑Êú¨
                        this.lastStablePitch = medianPitch;
                    }
                    
                    return this.lastStablePitch || medianPitch;
                }

                applyFrequencyBias(pitch) {
                    if (!pitch) return null;
                    
                    // Â∞ÜÈ¢ëÁéáËΩ¨Êç¢‰∏∫Èü≥Á¨¶
                    const note = this.frequencyToNoteName(pitch);
                    
                    // Â∫îÁî®ÁâπÂÆöÈü≥Á¨¶ÁöÑÈ¢ëÁéáÂÅèÂ∑ÆÊ†°Ê≠£
                    if (note && this.frequencyBias[note.name]) {
                        return pitch * this.frequencyBias[note.name];
                    }
                    
                    return pitch;
                }

                frequencyToNoteName(frequency) {
                    const A4 = 440;
                    const noteNames = ['C', 'C‚ôØ', 'D', 'D‚ôØ', 'E', 'F', 'F‚ôØ', 'G', 'G‚ôØ', 'A', 'A‚ôØ', 'B'];
                    
                    const noteNum = 12 * (Math.log2(frequency / A4)) + 69;
                    const noteIndex = Math.round(noteNum) % 12;
                    const octave = Math.floor(noteNum / 12) - 1;
                    
                    return {
                        name: noteNames[noteIndex],
                        octave: octave
                    };
                }

                calculateConfidence(pitch, sampleRate) {
                    // Â¢ûÂº∫ÁöÑÁΩÆ‰ø°Â∫¶ËÆ°ÁÆóÔºåÁâπÂà´ÂÖ≥Ê≥®FÂíåF#Âå∫Âüü
                    if (pitch < 65 || pitch > 1000) return 0;
                    
                    // FÂíåF#ÁöÑÈ¢ëÁéáËåÉÂõ¥
                    const isInFRange = pitch >= 340 && pitch <= 380;
                    
                    // ÂØπFÂíåF#Âå∫ÂüüÁªô‰∫àÊõ¥È´òÁöÑÂü∫Á°ÄÁΩÆ‰ø°Â∫¶
                    let confidence = isInFRange ? 1.2 : 1.0;
                    
                    // Ê†πÊçÆÈ¢ëÁéáËåÉÂõ¥Ë∞ÉÊï¥ÁΩÆ‰ø°Â∫¶
                    if (pitch < 100) confidence *= 0.8;
                    else if (pitch > 800) confidence *= 0.8;
                    
                    return Math.min(1.0, confidence);
                }
            }

            // Èü≥È´òÊ£ÄÊµãËæÖÂä©ÂèòÈáè
            const medianFilter = new MedianFilter(5);
            let smoothedFreq = null;
            
            // È¢ëÁéáËΩ¨Êç¢‰∏∫Èü≥Á¨¶ÂêçÁß∞ÂíåÂÖ´Â∫¶
            function freqToNoteInfo(freq) {
                if (!freq || freq <= 0) return null;
                const A4 = 440;
                const noteNumber = 12 * (Math.log(freq / A4) / Math.log(2)) + 69;
                const rounded = Math.round(noteNumber);
                const noteIndex = (rounded + 120) % 12;
                const octave = Math.floor(rounded / 12) - 1;
                const name = NOTE_NAMES[noteIndex] + octave;
                const cents = Math.round((noteNumber - rounded) * 100);
                return { name, cents, midi: rounded };
            }
            
            // Â¢ûÂº∫‰ΩéÈ¢ëÊ£ÄÊµãÁöÑÈü≥È¢ëÂ§ÑÁêÜÂáΩÊï∞
            // ‰øÆÊîπprocessAudioÂáΩÊï∞ÔºåÂú®ÂÜ∑Âç¥ÊúüÂÜÖ‰∏çÂ§ÑÁêÜÈü≥È¢ë
            function processAudio(event) {
                if (!isRecording || state.isAnswered || state.isCoolingDown) return;
                
                const inputData = event.inputBuffer.getChannelData(0);
                const sampleRate = audioContext.sampleRate;
                
                // Âä®ÊÄÅË∞ÉÊï¥YINÁÆóÊ≥ïÂèÇÊï∞ - ‰ΩéÈ¢ë‰ΩøÁî®Êõ¥È´òÁÅµÊïèÂ∫¶
                const isLowFrequencyTarget = state.currentSequence.some(interval => {
                    const rootValue = noteToSemitones[state.rootNote];
                    const semitone = (rootValue + intervalToSemitones[interval]) % 12;
                    const freq = 440 * Math.pow(2, (semitone - 9) / 12);
                    return freq < 110; // A2‰ª•‰∏ãËßÜ‰∏∫‰ΩéÈ¢ë
                });
                
                const yinParams = isLowFrequencyTarget ? 
                    {threshold: 0.05, probabilityCliff: 0.05} : // ‰ΩéÈ¢ëÂèÇÊï∞
                    {threshold: 0.1, probabilityCliff: 0.1};   // Â∏∏ËßÑÂèÇÊï∞
                
                const yinResult = Pitchfinder.YIN(yinParams)(inputData);
                
                if (!yinResult || !yinResult.frequency) return;
                
                // Âä®ÊÄÅËÉΩÈáèÊ£ÄÊµã - ‰ΩéÈ¢ë‰ΩøÁî®Êõ¥‰ΩéÈòàÂÄº
                const energy = rms(inputData);
                const energyThreshold = yinResult.frequency < 110 ? 0.001 : 0.002;
                if (energy < energyThreshold) return;
                
                // Ë∞êÊ≥¢Â¢ûÂº∫Â§ÑÁêÜ - ÁâπÂà´ÈíàÂØπ‰ΩéÈ¢ë
                let detectedFreq = yinResult.frequency;
                if (detectedFreq < 110) {
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÂü∫È¢ëÁöÑË∞êÊ≥¢
                    const possibleFundamental = detectedFreq / 2;
                    const fundamentalResult = Pitchfinder.YIN(yinParams)(inputData);
                    if (fundamentalResult && fundamentalResult.frequency && 
                        Math.abs(fundamentalResult.frequency - possibleFundamental) < 5) {
                        detectedFreq = possibleFundamental;
                    }
                }
                
                const currentInterval = state.currentSequence[state.currentStep];
                const rootValue = noteToSemitones[state.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;
                const targetFrequency = 440 * Math.pow(2, (targetSemitone - 9) / 12);
                
                // ‰ºòÂåñÈü≥È´òÂåπÈÖçÁÆóÊ≥ï
                const cents = 1200 * Math.log2(detectedFreq / targetFrequency);
                const centsMod = Math.abs(cents) % 1200;
                const adjustedCents = centsMod > 600 ? 1200 - centsMod : centsMod;
                
                // Âä®ÊÄÅË∞ÉÊï¥ÂåπÈÖçÈòàÂÄº - ‰ΩéÈ¢ëÊõ¥ÂÆΩÊùæ
                const threshold = detectedFreq < 110 ? 35 : 
                                 currentInterval === '1' ? 25 : 15;
                
                if (adjustedCents <= threshold && yinResult.probability > 0.6) {
                    handleCorrectAnswer();
                }
                
                updatePitchDisplay(detectedFreq, cents, yinResult.probability);
            }

            
            // Â∫îÁî®È´òÈÄöÊª§Ê≥¢Âô®
            function applyHighPassFilter(buffer, cutoffFreq, sampleRate) {
                const RC = 1.0 / (cutoffFreq * 2 * Math.PI);
                const dt = 1.0 / sampleRate;
                const alpha = RC / (RC + dt);
                
                let y = buffer[0];
                for (let i = 1; i < buffer.length; i++) {
                    y = alpha * (y + buffer[i] - buffer[i-1]);
                    buffer[i] = y;
                }
            }
            
            // Â∫îÁî®‰ΩéÈÄöÊª§Ê≥¢Âô®
            function applyLowPassFilter(buffer, cutoffFreq, sampleRate) {
                const RC = 1.0 / (cutoffFreq * 2 * Math.PI);
                const dt = 1.0 / sampleRate;
                const alpha = dt / (RC + dt);
                
                let y = buffer[0];
                for (let i = 1; i < buffer.length; i++) {
                    y = y + alpha * (buffer[i] - y);
                    buffer[i] = y;
                }
            }
            
            // ËÆ°ÁÆó‰ø°Âè∑Âº∫Â∫¶‰Ωú‰∏∫ÁΩÆ‰ø°Â∫¶ÁöÑ‰º∞ËÆ°
            function calculateSignalStrength(buffer) {
                let sum = 0;
                for (let i = 0; i < buffer.length; i++) {
                    sum += Math.abs(buffer[i]);
                }
                const average = sum / buffer.length;
                return Math.min(1.0, average * 10);
            }
            
            // È¢ëÁéáËΩ¨Êç¢‰∏∫Èü≥Á¨¶ÂêçÁß∞ÂíåÂÖ´Â∫¶
            function frequencyToNoteName(frequency) {
                const A4 = 440;
                const noteNames = ['C', 'C‚ôØ', 'D', 'D‚ôØ', 'E', 'F', 'F‚ôØ', 'G', 'G‚ôØ', 'A', 'A‚ôØ', 'B'];
                
                const noteNum = 12 * (Math.log2(frequency / A4)) + 69;
                const noteIndex = Math.round(noteNum) % 12;
                const octave = Math.floor(noteNum / 12) - 1;
                
                return {
                    name: noteNames[noteIndex],
                    octave: octave
                };
            }
            
            // Ê£ÄÊü•Ê£ÄÊµãÂà∞ÁöÑÈü≥È´òÊòØÂê¶ÂåπÈÖçÂΩìÂâçÊ≠•È™§ÁöÑÁõÆÊ†áÈü≥È´ò
            function checkPitchMatch(detectedPitch, confidence) {
                if (state.isAnswered || confidence < state.confidenceThreshold) return;
                
                const currentInterval = state.currentSequence[state.currentStep];
                const rootValue = noteToSemitones[state.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;
                
                const targetFrequency = 440 * Math.pow(2, (targetSemitone - 9) / 12);
                
                const cents = 1200 * Math.log2(detectedPitch / targetFrequency);
                
                updatePitchDisplay(detectedPitch, cents, confidence);
                
                const centsMod = Math.abs(cents) % 1200;
                const adjustedCents = centsMod > 600 ? 1200 - centsMod : centsMod;
                
                // ÂØπFÂíåF#Èü≥Á¨¶‰ΩøÁî®Êõ¥ÂÆΩÊùæÁöÑÂåπÈÖçÊ†áÂáÜ
                const detectedNote = frequencyToNoteName(detectedPitch);
                let centsThreshold = 20; // ÈªòËÆ§Èü≥ÂàÜÂ∑ÆÈòàÂÄº
                
                // Ê£ÄÊü•ÁõÆÊ†áÈü≥Á¨¶ÊòØÂê¶‰∏∫FÊàñF#
                const targetNote = frequencyToNoteName(targetFrequency);
                if (targetNote.name === 'F' || targetNote.name === 'F‚ôØ') {
                    centsThreshold = 35; // ÂØπFÂíåF#‰ΩøÁî®Êõ¥ÂÆΩÊùæÁöÑÈòàÂÄº
                }
                
                // Â¶ÇÊûúÊ£ÄÊµãÂà∞ÁöÑÈü≥Á¨¶ÊòØFÊàñF#Ôºå‰πü‰ΩøÁî®Êõ¥ÂÆΩÊùæÁöÑÈòàÂÄº
                if (detectedNote.name === 'F' || detectedNote.name === 'F‚ôØ') {
                    centsThreshold = Math.max(centsThreshold, 35);
                }
                
                if (adjustedCents <= centsThreshold) {
                    handleCorrectAnswer();
                }
            }
            
            // Êõ¥Êñ∞ÂÆûÊó∂Èü≥È´òÊòæÁ§∫
            function updatePitchDisplay(frequency, cents, confidence) {
                const pitchDisplay = document.getElementById('pitchDisplay');
                if (!pitchDisplay) return;
                
                const note = frequencyToNoteName(frequency);
                const centsMod = cents % 1200;
                const adjustedCents = centsMod > 600 ? centsMod - 1200 : centsMod;
                const roundedFreq = Math.round(frequency);
                const roundedCents = Math.round(adjustedCents);
                const confidencePercent = Math.round(confidence * 100);
                
                if (!pitchDisplay._cache) {
                    pitchDisplay._cache = {
                        note: '',
                        octave: '',
                        freq: 0,
                        cents: 0,
                        confidence: 0,
                        inTune: false
                    };
                }
                
                const cache = pitchDisplay._cache;
                const inTune = Math.abs(adjustedCents) <= 20;
                
                if (cache.note !== note.name || 
                    cache.octave !== note.octave || 
                    cache.freq !== roundedFreq || 
                    cache.cents !== roundedCents || 
                    cache.confidence !== confidencePercent ||
                    cache.inTune !== inTune) {
                    
                    cache.note = note.name;
                    cache.octave = note.octave;
                    cache.freq = roundedFreq;
                    cache.cents = roundedCents;
                    cache.confidence = confidencePercent;
                    cache.inTune = inTune;
                    
                    const children = pitchDisplay.children;
                    
                    if (children.length < 3) {
                        pitchDisplay.innerHTML = `
                            <div>Èü≥È´ò: ${note.name}${note.octave} (${roundedFreq}Hz)</div>
                            <div>Èü≥ÂàÜÂ∑Æ: ${adjustedCents > 0 ? '+' : ''}${roundedCents}</div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                            </div>
                        `;
                    } else {
                        children[0].textContent = `Èü≥È´ò: ${note.name}${note.octave} (${roundedFreq}Hz)`;
                        children[1].textContent = `Èü≥ÂàÜÂ∑Æ: ${adjustedCents > 0 ? '+' : ''}${roundedCents}`;
                        children[2].querySelector('.confidence-fill').style.width = `${confidencePercent}%`;
                    }
                    
                    pitchDisplay.classList.toggle('in-tune', inTune);
                    pitchDisplay.classList.toggle('out-of-tune', !inTune);
                }
            }
            
            // ‰ºòÂåñÂêéÁöÑÊ≠£Á°ÆÁ≠îÊ°àÂ§ÑÁêÜ
            function handleCorrectAnswer() {
                state.correctCount++;
                state.currentStep++;
                const justDone = state.currentStep - 1;
            
                const el = document.querySelector(`.sequence-item[data-index="${justDone}"]`);
                if (el) {
                    el.classList.remove('current');
                    el.classList.add('played');
                }
            
                requestAnimationFrame(() => {
                    if (state.currentStep >= state.currentSequence.length) {
                        state.isAnswered = true;
                        
                        // ËøõÂÖ•ÂÜ∑Âç¥ÊúüÔºåÈò≤Ê≠¢ËØØËß¶Âèë‰∏ã‰∏ÄÈ¢ò
                        state.isCoolingDown = true;
                        if (state.cooldownTimeout) {
                            clearTimeout(state.cooldownTimeout);
                        }
                        state.cooldownTimeout = setTimeout(() => {
                            state.isCoolingDown = false;
                        }, state.cooldownDuration);
                        
                        // Âª∂ËøüÁîüÊàê‰∏ã‰∏ÄÈ¢òÔºåÁªôÁî®Êà∑ÂÅúÊ≠¢ÂºπÂ•èÁöÑÊó∂Èó¥
                        setTimeout(() => {
                            generateExercise();
                        }, 600);
                    } else {
                        const next = document.querySelector(`.sequence-item[data-index="${state.currentStep}"]`);
                        if (next) next.classList.add('current');
                    }
                });
            }
            
            // È¢ÑÁîüÊàê‰∏ã‰∏Ä‰∏™ÁªÉ‰π†
            function generateNextExercise() {
                const activeTab = document.querySelector('.settings-tab.active').dataset.tab;
                
                if (activeTab === 'scale') {
                    let rootNote = rootNoteEl.value;
                    if (rootNote === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2 && n !== 'D‚ô≠' && n !== 'E‚ô≠' && n !== 'G‚ô≠' && n !== 'A‚ô≠' && n !== 'B‚ô≠');
                        rootNote = notes[Math.floor(Math.random() * notes.length)];
                    }
                    
                    let scaleType = scaleTypeEl.value;
                    if (scaleType === 'random') {
                        const types = Object.keys(scaleTypes);
                        scaleType = types[Math.floor(Math.random() * types.length)];
                    }
                    
                    const activeOrderBtn = document.querySelector('.scale-order-btn.active');
                    const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                    
                    let intervals = [...scaleTypes[scaleType].intervals];
                    // ÊâÄÊúâÊ®°ÂºèÈÉΩÊ∑ªÂä†È´òÂÖ´Â∫¶ÁöÑ1Èü≥
                    const octaveRoot = intervals[0];
                    
                    if (order === 'reverse') {
                        // ÂÄíÂ∫èÊ®°ÂºèÔºö17654321
                        const middleIntervals = intervals.slice(1).reverse();
                        intervals = [octaveRoot, ...middleIntervals, octaveRoot];
                    } else if (order === 'random') {
                        // ‰π±Â∫èÊ®°Âºè (‰øùÊåÅÁ¨¨‰∏Ä‰∏™Èü≥‰∏çÂèò)
                        const otherIntervals = intervals.slice(1);
                        for (let i = otherIntervals.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                        }
                        intervals = [octaveRoot, ...otherIntervals, octaveRoot];
                    } else {
                        // È°∫Â∫èÊ®°ÂºèÔºö12345671 (ÈªòËÆ§)
                        intervals.push(octaveRoot);
                    }
                    
                    state.nextExerciseInfo = `${rootNote} ${scaleTypes[scaleType].name}`;
                    state.nextExerciseIntervals = intervals;
                } else {
                    // Â¶ÇÊûúÊòØËá™ÂÆö‰πâÂíåÂº¶Ê®°ÂºèÔºåÁõ¥Êé•‰ªéËá™ÂÆö‰πâÂíåÂº¶Â∫èÂàó‰∏≠Ëé∑Âèñ‰∏ã‰∏Ä‰∏™ÂíåÂº¶
                    if (useCustomChords.checked && customChordSequence.querySelectorAll('.chord-item').length > 0) {
                        const chordItems = customChordSequence.querySelectorAll('.chord-item');
                        const chords = Array.from(chordItems).map(item => {
                            const root = item.querySelector('.remove-chord').dataset.root;
                            const type = item.querySelector('.remove-chord').dataset.type;
                            return { root, type };
                        });
                        
                        const currentIndex = state.customChordIndex !== undefined ? state.customChordIndex : 0;
                        const nextIndex = (currentIndex + 1) % chords.length;
                        const nextChord = chords[nextIndex];
                        
                        state.nextExerciseInfo = `${nextChord.root}${nextChord.type === 'major' ? '' : nextChord.type === 'minor' ? 'm' : nextChord.type === 'dominant7' ? '7' : nextChord.type === 'major7' ? 'maj7' : nextChord.type === 'minor7' ? 'm7' : nextChord.type === 'sus2' ? 'sus2' : 'sus4'}`;
                        state.nextExerciseIntervals = [...chordTypes[nextChord.type].intervals];
                    } else {
                        let rootNote = chordRootNoteEl.value;
                        if (rootNote === 'random') {
                            const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2 && n !== 'D‚ô≠' && n !== 'E‚ô≠' && n !== 'G‚ô≠' && n !== 'A‚ô≠' && n !== 'B‚ô≠');
                            rootNote = notes[Math.floor(Math.random() * notes.length)];
                        }
                        
                        const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                        let chordType = 'major';
                        if (activeChordTypes.length > 0) {
                            const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                            chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                        }
                        
                        const activeOrderBtn = document.querySelector('.chord-order-btn.active');
                        const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                        
                        let intervals = [...chordTypes[chordType].intervals];
                        if (order === 'random') {
                            for (let i = intervals.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [intervals[i], intervals[j]] = [intervals[j], intervals[i]];
                            }
                        }
                        
                        const chordSymbol = `${rootNote}${chordType === 'major' ? '' : chordType === 'minor' ? 'm' : chordType === 'dominant7' ? '7' : chordType === 'major7' ? 'maj7' : chordType === 'minor7' ? 'm7' : chordType === 'sus2' ? 'sus2' : 'sus4'}`;
                        state.nextExerciseInfo = chordSymbol;
                        state.nextExerciseIntervals = intervals;
                    }
                    
                    const chordSymbol = chordType === 'major' ? '' : 
                                      chordType === 'minor' ? 'm' : 
                                      chordType === 'dominant7' ? '7' : 
                                      chordType === 'major7' ? 'maj7' : 
                                      chordType === 'minor7' ? 'm7' : 
                                      chordType === 'minor7b5' ? 'm7‚ô≠5' :
                                      chordType === 'dominant9' ? '9' :
                                      chordType === 'major9' ? 'maj9' :
                                      chordType === 'minor9' ? 'm9' :
                                      chordType === 'sus2' ? 'sus2' : 'sus4';
                    
                    state.nextExerciseInfo = `${rootNote}${chordSymbol}`;
                    state.nextExerciseIntervals = intervals;
                }
                
                updateNextExerciseDisplay();
            }
            function requestRecordPermission() {
                // ÂÆö‰πâÊùÉÈôêÂ∏∏Èáè
                const recordPermission = 'android.permission.RECORD_AUDIO';
                
                // 1. Ê£ÄÊü•ÊùÉÈôêÁä∂ÊÄÅ
                plus.android.requestPermissions(
                    [recordPermission], // Ë¶ÅÁî≥ËØ∑ÁöÑÊùÉÈôêÂàóË°®
                    function(result) {
                        // 3. Â§ÑÁêÜÊéàÊùÉÁªìÊûú
                        console.log('Áî≥ËØ∑ÁªìÊûú:', result);
                        if (result.deniedAlways.length > 0) {
                            // Áî®Êà∑Â∑≤Ê∞∏‰πÖÊãíÁªùÔºåÈúÄË¶ÅÂºïÂØºÁî®Êà∑Âà∞Á≥ªÁªüËÆæÁΩÆÈ°µÊâãÂä®ÂºÄÂêØ
                            console.log('Áî®Êà∑Â∑≤Ê∞∏‰πÖÊãíÁªùÂΩïÈü≥ÊùÉÈôêÔºåÈúÄË¶ÅÂºïÂØºËá≥ËÆæÁΩÆÈ°µÈù¢');
                            // ËøôÈáåÂèØ‰ª•ÂºπÂá∫‰∏Ä‰∏™Ëá™ÂÆö‰πâÂØπËØùÊ°ÜÔºåÊèêÁ§∫Áî®Êà∑ÂéªÂ∫îÁî®ËÆæÁΩÆ‰∏≠ÊâìÂºÄÊùÉÈôê
                            // ...
                        } else if (result.deniedPresent.length > 0) {
                            // Áî®Êà∑Ê≠§Ê¨°ÊãíÁªùÔºå‰ΩÜÊú™ÂãæÈÄâ"‰∏çÂÜçËØ¢ÈóÆ"
                            console.log('Áî®Êà∑ÊãíÁªùÊéàÊùÉ');
                            // ÂèØ‰ª•Ê†πÊçÆÊÉÖÂÜµÈÄâÊã©ÂÜçÊ¨°Ëß£ÈáäÂêéÁî≥ËØ∑
                        } else if (result.granted.length > 0) {
                            // Áî®Êà∑Â∑≤ÊéàÊùÉÔºåÂèØ‰ª•ÂºÄÂßãÂΩïÈü≥
                            console.log('ÂΩïÈü≥ÊùÉÈôêÂ∑≤Ëé∑Âèñ');
                            // Ë∞ÉÁî®‰Ω†ÁöÑÂºÄÂßãÂΩïÈü≥ÈÄªËæë
                            // startRecording();
                        }
                    },
                    function(error) {
                        // Áî≥ËØ∑ËøáÁ®ãÂèëÁîüÈîôËØØ
                        console.error('Áî≥ËØ∑ÊùÉÈôêÂá∫Èîô:', error);
                    }
                );
            }
            // Êõ¥Êñ∞‰∏ã‰∏Ä‰∏™ÁªÉ‰π†ÊòæÁ§∫
            function updateNextExerciseDisplay() {
                if (state.nextExerciseInfo && state.nextExerciseIntervals.length > 0) {
                    nextExerciseEl.innerHTML = `${state.nextExerciseInfo}<br><span style="font-size: 14px; color: #94a3b8;">${state.nextExerciseIntervals.join(' ')}</span>`;
                }
            }
            
            // ‰ºòÂåñÂêéÁöÑÁªÉ‰π†ÁîüÊàêÂáΩÊï∞
            // ‰øÆÊîπgenerateExerciseÂáΩÊï∞ÔºåÈáçÁΩÆÂÜ∑Âç¥ÊúüÁä∂ÊÄÅ
            function generateExercise() {
                state.pitchBuffer = [];
                state.isAnswered = false;
                state.currentStep = 0;
                
                // ÈáçÁΩÆÂÜ∑Âç¥ÊúüÁä∂ÊÄÅ
                state.isCoolingDown = false;
                if (state.cooldownTimeout) {
                    clearTimeout(state.cooldownTimeout);
                    state.cooldownTimeout = null;
                }
                
                // ‰ΩøÁî®È¢ÑÂä†ËΩΩÁöÑÁªÉ‰π†Êï∞ÊçÆ
                if (state.nextExerciseInfo && state.nextExerciseIntervals.length > 0) {
                    const activeTab = document.querySelector('.settings-tab.active').dataset.tab;
                    
                    if (activeTab === 'scale') {
                        const parts = state.nextExerciseInfo.split(' ');
                        state.rootNote = parts[0];
                        state.scaleType = Object.keys(scaleTypes).find(key => scaleTypes[key].name === parts[1]);
                        state.currentIntervals = [...state.nextExerciseIntervals];
                        targetIntervalEl.textContent = state.nextExerciseInfo;
                    } else {
                        // Â¶ÇÊûúÊòØËá™ÂÆö‰πâÂíåÂº¶Ê®°ÂºèÔºåÁõ¥Êé•‰ªéËá™ÂÆö‰πâÂíåÂº¶Â∫èÂàó‰∏≠Ëé∑ÂèñÂΩìÂâçÂíåÂº¶
                        if (useCustomChords.checked && customChordSequence.querySelectorAll('.chord-item').length > 0) {
                            const chordItems = customChordSequence.querySelectorAll('.chord-item');
                            const chords = Array.from(chordItems).map(item => {
                                const root = item.querySelector('.remove-chord').dataset.root;
                                const type = item.querySelector('.remove-chord').dataset.type;
                                return { root, type };
                            });
                            
                            const currentIndex = state.customChordIndex !== undefined ? state.customChordIndex : 0;
                            const chord = chords[currentIndex];
                            
                            state.rootNote = chord.root;
                            state.chordType = chord.type;
                            state.currentIntervals = [...state.nextExerciseIntervals];
                            targetIntervalEl.textContent = state.nextExerciseInfo;
                        } else {
                            const chordMatch = state.nextExerciseInfo.match(/([A-G][‚ôØ‚ô≠]?)(.*)/);
                            state.rootNote = chordMatch[1];
                            
                            const chordSymbol = chordMatch[2];
                            state.chordType = chordSymbol === '' ? 'major' : 
                                             chordSymbol === 'm' ? 'minor' : 
                                             chordSymbol === '7' ? 'dominant7' : 
                                             chordSymbol === 'maj7' ? 'major7' : 
                                             chordSymbol === 'm7' ? 'minor7' : 
                                             chordSymbol === 'sus2' ? 'sus2' : 'sus4';
                                             
                            state.currentIntervals = [...state.nextExerciseIntervals];
                            targetIntervalEl.textContent = state.nextExerciseInfo;
                        }
                    }
                    
                    displaySequence();
                    
                    // Á´ãÂç≥È¢ÑÂä†ËΩΩ‰∏ã‰∏ÄÈ¢ò
                    generateNextExercise();
                } else {
                    // È¶ñÊ¨°Âä†ËΩΩÊó∂ÁîüÊàê‰∏§È¢ò
                    const activeTab = document.querySelector('.settings-tab.active').dataset.tab;
                    if (activeTab === 'scale') {
                        generateScaleExercise();
                    } else {
                        generateChordExercise();
                    }
                    
                    generateNextExercise();
                }
            }
            
            // ÁîüÊàêÈü≥Èò∂ÁªÉ‰π†
            function generateScaleExercise() {
                let rootNote = rootNoteEl.value;
                if (rootNote === 'random') {
                    const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2 && n !== 'D‚ô≠' && n !== 'E‚ô≠' && n !== 'G‚ô≠' && n !== 'A‚ô≠' && n !== 'B‚ô≠');
                    rootNote = notes[Math.floor(Math.random() * notes.length)];
                }
                state.rootNote = rootNote;
                
                let scaleType = scaleTypeEl.value;
                if (scaleType === 'random') {
                    const types = Object.keys(scaleTypes);
                    scaleType = types[Math.floor(Math.random() * types.length)];
                }
                state.scaleType = scaleType;
                
                state.currentIntervals = [...scaleTypes[scaleType].intervals];
                
                const activeScaleOrderBtn = document.querySelector('.scale-order-btn.active');
                const order = activeScaleOrderBtn ? activeScaleOrderBtn.dataset.value : 'ordered';
                const octaveRoot = state.currentIntervals[0];
                
                if (order === 'reverse') {
                    // ÂÄíÂ∫èÊ®°ÂºèÔºö17654321
                    const middleIntervals = state.currentIntervals.slice(1).reverse();
                    state.currentIntervals = [octaveRoot, ...middleIntervals, octaveRoot];
                } else if (order === 'random') {
                    // ‰π±Â∫èÊ®°Âºè (‰øùÊåÅÁ¨¨‰∏Ä‰∏™Èü≥‰∏çÂèò)
                    const otherIntervals = state.currentIntervals.slice(1);
                    for (let i = otherIntervals.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                    }
                    state.currentIntervals = [octaveRoot, ...otherIntervals];
                } else {
                    // È°∫Â∫èÊ®°ÂºèÔºö12345671 (ÈªòËÆ§)
                    state.currentIntervals.push(octaveRoot);
                }
                
                targetIntervalEl.textContent = `${rootNote} ${scaleTypes[scaleType].name}`;
                displaySequence();
            }
            
            // ÁîüÊàêÂíåÂº¶ÁªÉ‰π†
            function generateChordExercise() {
                if (useCustomChords.checked && customChordSequence.querySelectorAll('.chord-item').length > 0) {
                    // ‰ΩøÁî®Ëá™ÂÆö‰πâÂíåÂº¶Â∫èÂàó
                    const chordItems = customChordSequence.querySelectorAll('.chord-item');
                    const chords = Array.from(chordItems).map(item => {
                        const root = item.querySelector('.remove-chord').dataset.root;
                        const type = item.querySelector('.remove-chord').dataset.type;
                        return { root, type };
                    });
                    
                    // ÊåâÈ°∫Â∫èÁªÉ‰π†Ëá™ÂÆö‰πâÂíåÂº¶Â∫èÂàó
                    const currentChordIndex = state.customChordIndex || 0;
                    const chord = chords[currentChordIndex];
                    
                    state.rootNote = chord.root;
                    state.chordType = chord.type;
                    state.currentIntervals = [...chordTypes[state.chordType].intervals];
                    
                    const activeChordOrderBtn = document.querySelector('.chord-order-btn.active');
                    const order = activeChordOrderBtn ? activeChordOrderBtn.dataset.value : 'ordered';
                    if (order === 'random') {
                        for (let i = state.currentIntervals.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [state.currentIntervals[i], state.currentIntervals[j]] = [state.currentIntervals[j], state.currentIntervals[i]];
                        }
                    }
                    
                    const chordSymbol = `${state.rootNote}${state.chordType === 'major' ? '' : state.chordType === 'minor' ? 'm' : state.chordType === 'dominant7' ? '7' : state.chordType === 'major7' ? 'maj7' : state.chordType === 'minor7' ? 'm7' : state.chordType === 'sus2' ? 'sus2' : 'sus4'}`;
                    targetIntervalEl.textContent = chordSymbol;
                    displaySequence();
                    
                    // ËÆæÁΩÆ‰∏ã‰∏Ä‰∏™ÂíåÂº¶‰∏∫Â∫èÂàó‰∏≠ÁöÑ‰∏ã‰∏Ä‰∏™
                    const nextIndex = (currentChordIndex + 1) % chords.length;
                    state.customChordIndex = nextIndex;
                    const nextChord = chords[nextIndex];
                    
                    state.nextExerciseInfo = `${nextChord.root}${nextChord.type === 'major' ? '' : nextChord.type === 'minor' ? 'm' : nextChord.type === 'dominant7' ? '7' : nextChord.type === 'major7' ? 'maj7' : nextChord.type === 'minor7' ? 'm7' : nextChord.type === 'sus2' ? 'sus2' : 'sus4'}`;
                    state.nextExerciseIntervals = [...chordTypes[nextChord.type].intervals];
                    updateNextExerciseDisplay();
                } else {
                    // ‰ΩøÁî®ÂéüÂßãÂíåÂº¶ÁîüÊàêÈÄªËæë
                    state.customChordIndex = null;
                    originalGenerateChordExercise();
                }
            }
            
            // ÊòæÁ§∫Èü≥Èò∂/ÂíåÂº¶Â∫èÂàó
            function displaySequence() {
                const fragment = document.createDocumentFragment();
                state.currentSequence = [];
                
                state.currentIntervals.forEach((interval, index) => {
                    const span = document.createElement('div');
                    span.className = 'sequence-item';
                    if (index === 0) span.classList.add('current');
                    span.textContent = interval;
                    span.dataset.index = index;
                    fragment.appendChild(span);
                    state.currentSequence.push(interval);
                });
                
                sequenceDisplayEl.innerHTML = '';
                sequenceDisplayEl.appendChild(fragment);
            }
            
            // ÂêØÂä®ËäÇÊãçÂô®
            function startMetronome() {
                if (state.metronomeInterval) {
                    stopMetronome();
                }
                
                if (!state.metronomeEnabled) return;
                
                const beatInterval = 60000 / state.metronomeTempo;
                
                document.documentElement.style.setProperty('--metronome-speed', `${beatInterval}ms`);
                
                if (practiceScreen.style.display === 'flex') {
                    practiceScreen.classList.add('metronome-active');
                }
                
                state.metronomeInterval = setInterval(() => {
                    // ËÉåÊôØÈó™ÂÖâÊïàÊûú
                    practiceScreen.classList.add('metronome-flash');
                    setTimeout(() => {
                        practiceScreen.classList.remove('metronome-flash');
                    }, 300);
                    
                    // Êí≠ÊîæËäÇÊãçÂô®Â£∞Èü≥
                    if (audioContext) {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        oscillator.type = 'sine';
                        oscillator.frequency.value = 892; //ËøúÁ¶ª‰∏ÄËà¨‰πêÈü≥ÔºåÈÅøÂÖçÂπ≤Êâ∞
                        gainNode.gain.value = 0.1;
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.05);
                    }
                }, beatInterval);
            }
            
            // ÂÅúÊ≠¢ËäÇÊãçÂô®
            function stopMetronome() {
                if (state.metronomeInterval) {
                    clearInterval(state.metronomeInterval);
                    state.metronomeInterval = null;
                }
                
                practiceScreen.classList.remove('metronome-active');
                practiceScreen.classList.remove('metronome-flash');
            }
            
            // ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨Âô®
            function initEventListeners() {
                // Èü≥È¢ëËÆæÂ§áÈÄâÊã©‰∫ã‰ª∂
                audioInputDeviceEl.addEventListener('change', function() {
                    selectedDeviceId = this.value;
                    if (isRecording) {
                        restartAudioWithNewDevice();
                    }
                });
                
                // ËæìÂÖ•Â¢ûÁõäÊéßÂà∂
                inputGainEl.addEventListener('input', function() {
                    inputGain = this.value / 100;
                    inputGainValueEl.textContent = this.value + '%';
                    
                    if (gainNode) {
                        gainNode.gain.value = inputGain;
                    }
                });
                
                // Âà∑Êñ∞ËÆæÂ§áÂàóË°®
                refreshDevicesBtn.addEventListener('click', function() {
                    getAudioDevices();
                    updateStatusIndicator('Ê≠£Âú®Âà∑Êñ∞ËÆæÂ§áÂàóË°®...', 'ready');
                    setTimeout(() => {
                        updateStatusIndicator('ÂáÜÂ§áÂ∞±Áª™', 'ready');
                    }, 1000);
                });
                
                // ËäÇÊãçÂô®ÂºÄÂÖ≥‰∫ã‰ª∂
                metronomeToggleEl.addEventListener('change', function() {
                    state.metronomeEnabled = this.checked;
                    if (state.metronomeEnabled && practiceScreen.style.display === 'flex') {
                        startMetronome();
                    } else {
                        stopMetronome();
                    }
                });
                
                // ËäÇÊãçÂô®ÈÄüÂ∫¶ÊªëÂùó‰∫ã‰ª∂
                metronomeTempoEl.addEventListener('input', function() {
                    state.metronomeTempo = parseInt(this.value);
                    metronomeTempoValueEl.textContent = state.metronomeTempo;
                    
                    if (state.metronomeEnabled && state.metronomeInterval) {
                        startMetronome();
                    }
                });
                
                // ÂºÄÂßãÁªÉ‰π†ÊåâÈíÆ
                startBtn.addEventListener('click', function() {
                    updateStatusIndicator('Ê≠£Âú®ÂêØÂä®È∫¶ÂÖãÈ£é...', 'recording');
                    
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(function(stream) {
                            mediaStream = stream;
                            
                            mainScreen.style.display = 'none';
                            practiceScreen.style.display = 'flex';
                            document.getElementById('pitchDisplay').style.display = 'block';
                            
                            requestWakeLock();
                            
                            state.nextExerciseInfo = '';
                            state.nextExerciseIntervals = [];
                            
                            generateExercise();
                            
                            startRecording();
                            
                            state.metronomeEnabled = document.getElementById('metronomeToggle').checked;
                            state.metronomeTempo = parseInt(document.getElementById('metronomeTempo').value);
                            
                            if (state.metronomeEnabled) {
                                startMetronome();
                                practiceScreen.classList.add('metronome-active');
                            }
                        })
                        .catch(function(err) {
                            console.error('È∫¶ÂÖãÈ£éËé∑ÂèñÂ§±Ë¥•:', err);
                            
                            updateStatusIndicator('Êú™Ëé∑ÂèñÂΩïÈü≥ÊùÉÈôê', 'error');
                            
                            const errorMessage = document.createElement('div');
                            errorMessage.style.position = 'fixed';
                            errorMessage.style.top = '50%';
                            errorMessage.style.left = '50%';
                            errorMessage.style.transform = 'translate(-50%, -50%)';
                            errorMessage.style.background = 'rgba(239, 68, 68, 0.9)';
                            errorMessage.style.color = 'white';
                            errorMessage.style.padding = '20px';
                            errorMessage.style.borderRadius = '10px';
                            errorMessage.style.zIndex = '2000';
                            errorMessage.style.maxWidth = '80%';
                            errorMessage.style.textAlign = 'center';
                            errorMessage.innerHTML = `
                                <h3 style="margin-bottom: 10px; font-size: 18px;">È∫¶ÂÖãÈ£éÊùÉÈôêË¢´ÊãíÁªù</h3>
                                <p style="margin-bottom: 15px;">Ê≠§Â∫îÁî®ÈúÄË¶ÅÈ∫¶ÂÖãÈ£éÊùÉÈôêÊâçËÉΩÊ£ÄÊµãÈü≥È´ò„ÄÇ</p>
                                <p>ËØ∑Âú®ÊµèËßàÂô®ËÆæÁΩÆ‰∏≠ÂÖÅËÆ∏È∫¶ÂÖãÈ£éËÆøÈóÆÔºåÁÑ∂ÂêéÂà∑Êñ∞È°µÈù¢„ÄÇ</p>
                                <button id="returnToMain" style="margin-top: 15px; padding: 8px 16px; background: #3a9fc4; border: none; border-radius: 5px; color: white; cursor: pointer;">ËøîÂõû‰∏ªËèúÂçï</button>
                            `;
                            document.body.appendChild(errorMessage);
                            
                            document.getElementById('returnToMain').addEventListener('click', function() {
                                document.body.removeChild(errorMessage);
                                updateStatusIndicator('ÂáÜÂ§áÂ∞±Áª™', 'ready');
                            });
                        });
                });
                
                // ÈÄâÈ°πÂç°ÂàáÊç¢
                settingsTabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        const tabName = this.dataset.tab;
                        
                        settingsTabs.forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        
                        // ÈªòËÆ§ÈöêËóèÊâÄÊúâËÆæÁΩÆÂå∫Âüü
                        scaleSettings.style.display = 'none';
                        chordSettings.style.display = 'none';
                        deviceSettings.style.display = 'none';
                        
                        // Ê†πÊçÆÊ†áÁ≠æÈ°µÊòæÁ§∫ÂØπÂ∫îËÆæÁΩÆ
                        if (tabName === 'scale') {
                            scaleSettings.style.display = 'block';
                        } else if (tabName === 'chord') {
                            chordSettings.style.display = 'block';
                        } else if (tabName === 'device') {
                            deviceSettings.style.display = 'block';
                        }
                    });
                });
                
                // ÂàùÂßãÂåñÊòæÁ§∫Èü≥Èò∂ËÆæÁΩÆÔºàÂ¶ÇÊûúÊòØÈü≥Èò∂ÁªÉ‰π†Ê†áÁ≠æÈ°µÔºâ
                if (document.querySelector('.settings-tab.active').dataset.tab === 'scale') {
                    scaleSettings.style.display = 'block';
                }
                
                // ÂàùÂßãÂåñÊòæÁ§∫Èü≥Èò∂ËÆæÁΩÆÔºàÂ¶ÇÊûúÊòØÈü≥Èò∂ÁªÉ‰π†Ê†áÁ≠æÈ°µÔºâ
                if (document.querySelector('.settings-tab.active').dataset.tab === 'scale') {
                    scaleSettings.style.display = 'block';
                }
                
                // ÂíåÂº¶Á±ªÂûãÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
                chordTypeBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        this.classList.toggle('active');
                    });
                });
                
                // Èü≥Èò∂È°∫Â∫èÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
                const scaleOrderBtns = document.querySelectorAll('.scale-order-btn');
                scaleOrderBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        scaleOrderBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
                
                // ÂíåÂº¶È°∫Â∫èÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
                const chordOrderBtns = document.querySelectorAll('.chord-order-btn');
                chordOrderBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        chordOrderBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
                
                // ÁÇπÂáªÁªÉ‰π†Â±èÂπïËøîÂõû‰∏ªÈ°µÈù¢
			// ‰øÆÊîπÁªÉ‰π†Â±èÂπïÁÇπÂáª‰∫ã‰ª∂ÔºåÁ°Æ‰øùÈÄÄÂá∫Êó∂ÈáçÁΩÆÂÜ∑Âç¥Êúü
			practiceScreen.addEventListener('click', function() {
				updateStatusIndicator('Ê≠£Âú®ÂÅúÊ≠¢ÂΩïÈü≥...', 'ready');
				
				// ÈáçÁΩÆÂÜ∑Âç¥ÊúüÁä∂ÊÄÅ
				state.isCoolingDown = false;
				if (state.cooldownTimeout) {
					clearTimeout(state.cooldownTimeout);
					state.cooldownTimeout = null;
				}
				
				setTimeout(() => {
					stopRecording();
					stopMetronome();
					//releaseWakeLock();
					
					practiceScreen.style.display = 'none';
					document.getElementById('pitchDisplay').style.display = 'none';
					mainScreen.style.display = 'block';
					
					updateStatusIndicator('ÂáÜÂ§áÂ∞±Áª™', 'ready');
				}, 300);
			});
                // È°µÈù¢ÂÖ≥Èó≠Êó∂ÂÆåÂÖ®ÂÖ≥Èó≠È∫¶ÂÖãÈ£é
                window.addEventListener('beforeunload', function() {
                    closeMicrophone();
                });
            }
            
            // ÂàùÂßãÂåñÂ∫îÁî®
            function initApp() {
                if (typeof Pitchfinder === 'undefined') {
                    console.error('PitchFinderÂ∫ìÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
                    alert('Èü≥È´òÊ£ÄÊµãÂ∫ìÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂêéÂà∑Êñ∞È°µÈù¢');
                } else {
                    console.log('PitchFinderÂ∫ìÂä†ËΩΩÊàêÂäü');
                }
                
                // Ëé∑ÂèñÈü≥È¢ëËÆæÂ§áÂàóË°®
                getAudioDevices();
                
                initEventListeners();
                initKeyboardShortcuts();
				requestRecordPermission();
            }
            
            // ÂàùÂßãÂåñÈîÆÁõòÂø´Êç∑ÈîÆ
            function initKeyboardShortcuts() {
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && practiceScreen.style.display === 'flex') {
                        practiceScreen.click();
                    }
                    
                    if (e.key === ' ' && practiceScreen.style.display === 'flex') {
                        generateExercise();
                    }
                });
            }
            
            // Êõ¥Êñ∞Áä∂ÊÄÅÊåáÁ§∫Âô®
            function updateStatusIndicator(status, type = 'ready') {
                statusIndicator.textContent = status;
                statusIndicator.className = `status-indicator status-${type}`;
            }
            
            // Ëá™ÂÆö‰πâÂíåÂº¶ÂäüËÉΩ
            const useCustomChords = document.getElementById('useCustomChords');
            const customChordsControls = document.getElementById('customChordsControls');
            const customChordRoot = document.getElementById('customChordRoot');
            const customChordType = document.getElementById('customChordType');
            const addCustomChord = document.getElementById('addCustomChord');
            const customChordSequence = document.getElementById('customChordSequence');
            const clearCustomChords = document.getElementById('clearCustomChords');
            const saveCustomChords = document.getElementById('saveCustomChords');
            const loadCustomChords = document.getElementById('loadCustomChords');
            const sequenceName = document.getElementById('sequenceName');

            // Ëá™ÂÆö‰πâÂíåÂº¶ÂºÄÂÖ≥ÊéßÂà∂
            useCustomChords.addEventListener('change', function() {
                customChordsControls.style.display = this.checked ? 'block' : 'none';
            });

            // Ê∑ªÂä†Ëá™ÂÆö‰πâÂíåÂº¶
            addCustomChord.addEventListener('click', function() {
                const root = customChordRoot.value;
                const type = customChordType.value;
                const chordName = `${root}${type === 'major' ? '' : type === 'minor' ? 'm' : type === 'dominant7' ? '7' : type === 'major7' ? 'maj7' : type === 'minor7' ? 'm7' : type === 'sus2' ? 'sus2' : 'sus4'}`;
                
                const chordItem = document.createElement('div');
                chordItem.className = 'chord-item';
                chordItem.innerHTML = `
                    <span class="chord-name">${chordName}</span>
                    <button class="remove-chord" data-root="${root}" data-type="${type}">√ó</button>
                `;
                
                customChordSequence.appendChild(chordItem);
                
                // Ê∑ªÂä†Âà†Èô§‰∫ã‰ª∂
                chordItem.querySelector('.remove-chord').addEventListener('click', function() {
                    chordItem.remove();
                });
            });

            // Ê∏ÖÁ©∫Ëá™ÂÆö‰πâÂíåÂº¶Â∫èÂàó
            clearCustomChords.addEventListener('click', function() {
                customChordSequence.innerHTML = '<div class="empty-sequence">ÊöÇÊó†ÂíåÂº¶ÔºåËØ∑Ê∑ªÂä†</div>';
            });

            // ‰øùÂ≠òÂíåÂº¶Â∫èÂàóÂà∞Êú¨Âú∞Â≠òÂÇ®
            saveCustomChords.addEventListener('click', function() {
                const chords = [];
                const chordElements = customChordSequence.querySelectorAll('.chord-item');
                
                chordElements.forEach(el => {
                    const root = el.querySelector('.remove-chord').dataset.root;
                    const type = el.querySelector('.remove-chord').dataset.type;
                    chords.push({ root, type });
                });
                
                const name = sequenceName.value || 'Êú™ÂëΩÂêçÂ∫èÂàó';
                const songData = {
                    name,
                    chords,
                    timestamp: new Date().toISOString()
                };
                
                // ÂàõÂª∫Êñá‰ª∂‰øùÂ≠òÂØπËØùÊ°Ü
                const jsonStr = JSON.stringify([songData], null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${name.replace(/[\/\\?%*:|"<>]/g, '')}_ÂíåÂº¶Â∫èÂàó.json`;
                document.body.appendChild(a);
                a.click();
                
                // Ê∏ÖÁêÜ
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // ÂêåÊó∂‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                const sequences = JSON.parse(localStorage.getItem('customChordSequences') || '[]');
                sequences.push(songData);
                localStorage.setItem('customChordSequences', JSON.stringify(sequences));
            });

            // Âä†ËΩΩÊú¨Âú∞ÂíåÂº¶ËøõË°å
// Âä†ËΩΩÊú¨Âú∞ÂíåÂº¶ËøõË°å
            document.getElementById('loadLocalChords').addEventListener('click', function() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            // Â§ÑÁêÜÂ§öÈ¶ñÊ≠åÊõ≤Ê†ºÂºèÔºàÊï∞ÁªÑÂΩ¢ÂºèÔºâ
                            if (Array.isArray(data)) {
                                if (data.length === 0) {
                                    alert('Êñá‰ª∂‰∏∫Á©∫ÔºåÊ≤°ÊúâÂèØÂä†ËΩΩÁöÑÊ≠åÊõ≤');
                                } else if (data.length === 1) {
                                    loadAndStartPractice(data[0]);
                                } else {
                                    showSongSelectionDialog(data);
                                }
                            } 
                            // Â§ÑÁêÜÂçïÈ¶ñÊ≠åÊõ≤Ê†ºÂºèÔºàÂØπË±°ÂΩ¢ÂºèÔºâ
                            else if (data && Array.isArray(data.chords)) {
                                loadAndStartPractice(data);
                            } else {
                                alert('Êó†ÊïàÁöÑÂíåÂº¶ËøõË°åÊñá‰ª∂Ê†ºÂºè');
                            }
                        } catch (err) {
                            alert('Ëß£ÊûêÊñá‰ª∂Â§±Ë¥•: ' + err.message);
                        }
                    };
                    reader.readAsText(file);
                });
                
                fileInput.click();
                
        function loadAndStartPractice(songData) {
            customChordSequence.innerHTML = '';
            sequenceName.value = songData.name || 'Êú™ÂëΩÂêçÂ∫èÂàó';
            
            songData.chords.forEach(chord => {
                const chordName = `${chord.root}${chord.type === 'major' ? '' : 
                                chord.type === 'minor' ? 'm' : 
                                chord.type === 'dominant7' ? '7' : 
                                chord.type === 'major7' ? 'maj7' : 
                                chord.type === 'minor7' ? 'm7' : 
                                chord.type === 'sus2' ? 'sus2' : 'sus4'}`;
                
                const chordItem = document.createElement('div');
                chordItem.className = 'chord-item';
                chordItem.innerHTML = `
                    <span class="chord-name">${chordName}</span>
                    <button class="remove-chord" data-root="${chord.root}" data-type="${chord.type}">√ó</button>
                `;
                
                customChordSequence.appendChild(chordItem);
                
                chordItem.querySelector('.remove-chord').addEventListener('click', function() {
                    chordItem.remove();
                });
            });
            
            // Á°Æ‰øùËá™ÂÆö‰πâÂíåÂº¶Ê®°ÂºèÂºÄÂêØ
            useCustomChords.checked = true;
            customChordsControls.style.display = 'block';
            
            // ÈáçÁΩÆËá™ÂÆö‰πâÂíåÂº¶Á¥¢Âºï
            state.customChordIndex = 0;
            
            // È¢ÑÂä†ËΩΩÁ¨¨‰∏Ä‰∏™ÂíåÂº¶
            const firstChord = songData.chords[0];
            state.nextExerciseInfo = `${firstChord.root}${firstChord.type === 'major' ? '' : 
                                   firstChord.type === 'minor' ? 'm' : 
                                   firstChord.type === 'dominant7' ? '7' : 
                                   firstChord.type === 'major7' ? 'maj7' : 
                                   firstChord.type === 'minor7' ? 'm7' : 
                                   firstChord.type === 'sus2' ? 'sus2' : 'sus4'}`;
            state.nextExerciseIntervals = [...chordTypes[firstChord.type].intervals];
            
            // Ëá™Âä®ÂºÄÂßãÁªÉ‰π†
            setTimeout(() => {
                mainScreen.style.display = 'none';
                practiceScreen.style.display = 'flex';
                document.getElementById('pitchDisplay').style.display = 'block';
                requestWakeLock();
                generateExercise();
                startRecording();
                
                // ÂêØÁî®ËäÇÊãçÂô®ÔºàÂ¶ÇÊûúÂ∑≤ÈÄâ‰∏≠Ôºâ
                if (metronomeToggleEl.checked) {
                    startMetronome();
                }
            }, 300);
                    }
                
                function showSongSelectionDialog(songs) {
                    const dialog = document.createElement('div');
                    dialog.className = 'sequence-dialog';
                    dialog.style.width = '80%';
                    dialog.style.maxWidth = '500px';
                    dialog.innerHTML = `
                        <h3 style="margin-bottom: 15px; color: #3a9fc4;">ÈÄâÊã©Ë¶ÅÂä†ËΩΩÁöÑÊ≠åÊõ≤</h3>
                        <select id="songSelector" style="width: 100%; padding: 10px; margin-bottom: 15px; 
                         background: #2c2c3c; color: white; border: 1px solid #555; border-radius: 6px;">
                         ${songs.map(song => `
                        <option value="${songs.indexOf(song)}">
                        ${song.name || 'Êú™ÂëΩÂêç'} (${song.chords.map(chord => {
                            let suffix = '';
                            switch(chord.type) {
                                case 'major': suffix = ''; break;
                                case 'minor': suffix = 'm'; break;
                                case 'dominant7': suffix = '7'; break;
                                case 'major7': suffix = 'maj7'; break;
                                case 'minor7': suffix = 'm7'; break;
                                case 'sus2': suffix = 'sus2'; break;
                                case 'sus4': suffix = 'sus4'; break;
                                default: suffix = '';
                            }
                            return `${chord.root}${suffix}`;
                        }).join(' ')})
                        </option>
                            `).join('')}
                        </select>
                        <div style="display: flex; gap: 10px;">
                            <button id="confirmLoad" style="flex: 1; padding: 10px; background: #3a9fc4; 
                                border: none; border-radius: 6px; color: white; cursor: pointer;">
                                Âä†ËΩΩÂπ∂ÂºÄÂßãÁªÉ‰π†
                            </button>
                            <button id="cancelLoad" style="flex: 1; padding: 10px; background: #555; 
                                border: none; border-radius: 6px; color: white; cursor: pointer;">
                                ÂèñÊ∂à
                            </button>
                        </div>
                    `;
                    
                    document.body.appendChild(dialog);
                    
                    document.getElementById('confirmLoad').addEventListener('click', function() {
                        const selectedIndex = document.getElementById('songSelector').value;
                        loadAndStartPractice(songs[selectedIndex]);
                        document.body.removeChild(dialog);
                    });
                    
                    document.getElementById('cancelLoad').addEventListener('click', function() {
                        document.body.removeChild(dialog);
                    });
                }
            });


            // Âä†ËΩΩÂΩìÂâçËá™ÂÆö‰πâÂíåÂº¶Â∫èÂàóÂπ∂ÂºÄÂßãÁªÉ‰π†
            document.getElementById('loadSequence').addEventListener('click', function() {
                const chordItems = customChordSequence.querySelectorAll('.chord-item');
                if (chordItems.length === 0) {
                    alert('ËØ∑ÂÖàÊ∑ªÂä†Ëá™ÂÆö‰πâÂíåÂº¶');
                    return;
                }
                
                // Á°Æ‰øùËá™ÂÆö‰πâÂíåÂº¶Ê®°ÂºèÂºÄÂêØ
                useCustomChords.checked = true;
                customChordsControls.style.display = 'block';
                
                // ÈáçÁΩÆËá™ÂÆö‰πâÂíåÂº¶Á¥¢Âºï
                state.customChordIndex = 0;
                
                // Ëá™Âä®ÂºÄÂßãÁªÉ‰π†
                setTimeout(() => {
                    mainScreen.style.display = 'none';
                    practiceScreen.style.display = 'flex';
                    document.getElementById('pitchDisplay').style.display = 'block';
                    requestWakeLock();
                    generateExercise();
                    startRecording();
                    
                    // ÂêØÁî®ËäÇÊãçÂô®ÔºàÂ¶ÇÊûúÂ∑≤ÈÄâ‰∏≠Ôºâ
                    if (metronomeToggleEl.checked) {
                        startMetronome();
                    }
                }, 300);
            });

            // ‰øÆÊîπgenerateChordExerciseÂáΩÊï∞‰ª•ÊîØÊåÅËá™ÂÆö‰πâÂíåÂº¶
            function originalGenerateChordExercise() {
                let rootNote = chordRootNoteEl.value;
                if (rootNote === 'random') {
                    const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2 && n !== 'D‚ô≠' && n !== 'E‚ô≠' && n !== 'G‚ô≠' && n !== 'A‚ô≠' && n !== 'B‚ô≠');
                    rootNote = notes[Math.floor(Math.random() * notes.length)];
                }
                state.rootNote = rootNote;
                
                const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                let chordType = 'major';
                if (activeChordTypes.length > 0) {
                    const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                    chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                }
                state.chordType = chordType;
                
                state.currentIntervals = [...chordTypes[chordType].intervals];
                
                const activeChordOrderBtn = document.querySelector('.chord-order-btn.active');
                const order = activeChordOrderBtn ? activeChordOrderBtn.dataset.value : 'ordered';
                if (order === 'random') {
                    for (let i = state.currentIntervals.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [state.currentIntervals[i], state.currentIntervals[j]] = [state.currentIntervals[j], state.currentIntervals[i]];
                    }
                }
                
                const chordSymbol = `${rootNote}${chordType === 'major' ? '' : chordType === 'minor' ? 'm' : chordType === 'dominant7' ? '7' : chordType === 'major7' ? 'maj7' : chordType === 'minor7' ? 'm7' : chordType === 'sus2' ? 'sus2' : 'sus4'}`;
                targetIntervalEl.textContent = chordSymbol;
                displaySequence();
            }

            // ÈáçÊñ∞ÂÆö‰πâgenerateChordExerciseÂáΩÊï∞
            function generateChordExercise() {
                if (useCustomChords.checked && customChordSequence.querySelectorAll('.chord-item').length > 0) {
                    // ‰ΩøÁî®Ëá™ÂÆö‰πâÂíåÂº¶Â∫èÂàó
                    const chordItems = customChordSequence.querySelectorAll('.chord-item');
                    const chords = Array.from(chordItems).map(item => {
                        const root = item.querySelector('.remove-chord').dataset.root;
                        const type = item.querySelector('.remove-chord').dataset.type;
                        return { root, type };
                    });
                    
                    // ÊåâÈ°∫Â∫èÈÄâÊã©ÂíåÂº¶‰Ωú‰∏∫ÂΩìÂâçÁªÉ‰π†
                    const currentIndex = state.customChordIndex !== undefined ? state.customChordIndex : 0;
                    const chord = chords[currentIndex];
                    
                    state.rootNote = chord.root;
                    state.chordType = chord.type;
                    state.currentIntervals = [...chordTypes[state.chordType].intervals];
                    
                    const activeChordOrderBtn = document.querySelector('.chord-order-btn.active');
                    const order = activeChordOrderBtn ? activeChordOrderBtn.dataset.value : 'ordered';
                    if (order === 'random') {
                        for (let i = state.currentIntervals.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [state.currentIntervals[i], state.currentIntervals[j]] = [state.currentIntervals[j], state.currentIntervals[i]];
                        }
                    }
                    
                    const chordSymbol = `${state.rootNote}${state.chordType === 'major' ? '' : state.chordType === 'minor' ? 'm' : state.chordType === 'dominant7' ? '7' : state.chordType === 'major7' ? 'maj7' : state.chordType === 'minor7' ? 'm7' : state.chordType === 'sus2' ? 'sus2' : 'sus4'}`;
                    targetIntervalEl.textContent = chordSymbol;
                    displaySequence();
                    
                    // ËÆæÁΩÆ‰∏ã‰∏Ä‰∏™ÂíåÂº¶‰∏∫Â∫èÂàó‰∏≠ÁöÑ‰∏ã‰∏Ä‰∏™
                    const nextIndex = (currentIndex + 1) % chords.length;
                    state.customChordIndex = nextIndex; // Êõ¥Êñ∞Á¥¢Âºï‰∏∫‰∏ã‰∏Ä‰∏™
                    const nextChord = chords[nextIndex];
                    
                    state.nextExerciseInfo = `${nextChord.root}${nextChord.type === 'major' ? '' : nextChord.type === 'minor' ? 'm' : nextChord.type === 'dominant7' ? '7' : nextChord.type === 'major7' ? 'maj7' : nextChord.type === 'minor7' ? 'm7' : nextChord.type === 'sus2' ? 'sus2' : 'sus4'}`;
                    state.nextExerciseIntervals = [...chordTypes[nextChord.type].intervals];
                    updateNextExerciseDisplay();
                } else {
                    // ‰ΩøÁî®ÂéüÂßãÂíåÂº¶ÁîüÊàêÈÄªËæë
                    originalGenerateChordExercise();
                }
            }

            // ÂêØÂä®Â∫îÁî®
            initApp();
        });
    </script>
</body>
</html>
